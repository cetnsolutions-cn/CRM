<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDV CRM - V30 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Animations */
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes popIn { 0%{transform: scale(0.9); opacity: 0;} 100%{transform: scale(1); opacity: 1;} }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Confetti */
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 9999; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Scrollbar Masqu√©e */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .logo-img { width: 20px; height: 20px; object-fit: contain; border-radius: 4px; }
        .badge-status { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #2563EB; z-index: 50; position: relative; }

        /* Style sp√©cifique du Date Picker V22 */
        .date-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .date-card-selected {
            border-color: #2563EB; /* blue-600 */
            background-color: #2563EB;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -2px rgba(37, 99, 235, 0.5);
        }

        /* Masquer la fl√®che du datalist */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        /* --- NOUVEAUX STYLES POUR RENDRE-VOUS EN COURS --- */
        @keyframes status-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Animation BORDURE CARD (Demand√©e) */
        @keyframes border-pulse { 
            0% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 
            50% { border-color: rgba(34, 197, 94, 1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 
            100% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }
        .live-animation { animation: border-pulse 2s infinite; border: 2px solid #22c55e !important; }

        .status-label-active {
            font-size: 10px; font-weight: 900; text-transform: uppercase; color: #22c55e;
            display: flex; align-items: center; padding: 4px 8px; border-radius: 6px;
            background-color: #f0fdf4; border: 1px solid #bbf7d0; letter-spacing: 0.5px;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .status-label-active .live-dot {
            width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 6px;
            animation: status-pulse 1.5s infinite;
        }
       /* =========================================
           üéÖ TH√àME NO√ãL - ULTRA COMPLET üéÖ
           ========================================= */

        /* 1. CURSEUR SAPIN (Uniquement sur PC) */
        @media (min-width: 768px) {
            .theme-christmas, 
            .theme-christmas button, 
            .theme-christmas a, 
            .theme-christmas input {
                /* Remplace le curseur par un Sapin */
                cursor: url('https://img.icons8.com/color/32/christmas-tree.png'), auto !important;
            }
            /* Curseur "Main" devient un P√®re No√´l ou Cadeau */
            .theme-christmas .cursor-pointer {
                cursor: url('https://img.icons8.com/color/32/gift--v1.png'), pointer !important;
            }
        }

        /* 2. EFFET "GRELOT" (Les boutons tremblent au survol) */
        @keyframes jingle {
            0% { transform: rotate(0); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0); }
        }

        .theme-christmas button:hover,
        .theme-christmas .cursor-pointer:hover {
            animation: jingle 0.5s ease-in-out infinite; /* √áa grelotte ! */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8) !important; /* Lueur rouge */
        }

        /* 3. NEIGE MAGIQUE (Tombe et ondule) */
        .snowflake {
            position: fixed; top: -5vh; color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            pointer-events: none; z-index: 9999;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            25% { transform: translateY(25vh) translateX(15px) rotate(90deg); }
            50% { transform: translateY(50vh) translateX(-15px) rotate(180deg); }
            75% { transform: translateY(75vh) translateX(15px) rotate(270deg); }
            100% { transform: translateY(110vh) translateX(0) rotate(360deg); opacity: 0; }
        }

        /* 4. COULEURS & D√âGRAD√âS NO√ãL */
        .theme-christmas body { background-color: #fff1f2 !important; /* Fond ros√© hiver */ }

        /* Les boutons bleus deviennent ROUGE NO√ãL */
        .theme-christmas .bg-blue-600 { 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important; 
            border: 1px solid #fca5a5;
        }
        
        /* Les textes bleus deviennent VERT SAPIN */
        .theme-christmas .text-blue-600, 
        .theme-christmas .text-blue-500 { 
            color: #166534 !important; /* Vert fonc√© */
            font-weight: 800;
        }

        /* Fonds clairs (cartes) deviennent l√©g√®rement teint√©s */
        .theme-christmas .bg-blue-50 { background-color: #fef2f2 !important; border-color: #fecaca !important; }
        .theme-christmas .border-blue-200 { border-color: #fecaca !important; }

        /* 5. LOGO QUI RESPIRE (PULSE) */
        .theme-christmas .sidebar-logo {
            background: linear-gradient(135deg, #15803d 0%, #b91c1c 100%) !important;
            border: 2px solid #fbbf24; /* Bordure dor√©e */
            animation: christmas-pulse 3s infinite ease-in-out;
        }
        @keyframes christmas-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(220, 38, 38, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); transform: scale(1); }
        }

        /* 6. SUCRE D'ORGE (Barres de progression) */
        .theme-christmas .bg-blue-500, .theme-christmas .h-full.bg-black\/50 {
            background: repeating-linear-gradient(45deg, #dc2626, #dc2626 10px, #ffffff 10px, #ffffff 20px) !important;
            background-size: 28px 28px !important;
            animation: candy-stripe 1s linear infinite !important;
        }
        @keyframes candy-stripe { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }

        /* 7. ADAPTATION T√âL√âPHONE ("Typhons") */
        @media (max-width: 768px) {
            /* Sur mobile, le curseur redevient normal (pas de bug tactile) */
            .theme-christmas * { cursor: auto !important; }
            
            /* Les boutons importants respirent tout seuls (car pas de survol) */
            .theme-christmas button.bg-slate-900, /* Bouton Nouveau */
            .theme-christmas button.bg-blue-600 { /* Boutons actions */
                animation: heartbeat 2s infinite !important;
            }
            @keyframes heartbeat {
                0% { transform: scale(1); }
                10% { transform: scale(1.03); }
                20% { transform: scale(1); }
                100% { transform: scale(1); }
            }
        }

        /* --- AUTRES TH√àMES --- */
        .theme-summer .bg-blue-600 { background-color: #0ea5e9 !important; }
       /* =================================================================
           üéÉ HALLOWEEN : MODE "CYBER-WITCH" (Sombre & N√©on)
           ================================================================= */
        .theme-halloween body { 
            background: radial-gradient(circle at center, #2e1065 0%, #000000 100%) !important;
            color: #e4e4e7 !important;
        }
        
        /* Cartes "Verre Fum√©" */
        .theme-halloween .bg-white, .theme-halloween .bg-slate-50 { 
            background-color: rgba(20, 20, 20, 0.85) !important; 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3); /* Bordure violette */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            color: #fff !important;
        }

        /* Textes */
        .theme-halloween .text-slate-800, .theme-halloween .text-slate-700 { color: #fff !important; }
        .theme-halloween .text-slate-500 { color: #a1a1aa !important; }
        
        /* Boutons "Sortil√®ge" */
        .theme-halloween .bg-blue-600, .theme-halloween .bg-slate-900 { 
            background: linear-gradient(45deg, #f97316, #7c3aed) !important; 
            border: none;
            box-shadow: 0 0 15px #7c3aed;
            position: relative; overflow: hidden;
        }
        .theme-halloween .bg-blue-600:hover { box-shadow: 0 0 30px #f97316; transform: scale(1.02); }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-halloween * { cursor: url('https://img.icons8.com/color/32/ghost.png'), auto !important; }
            .theme-halloween .cursor-pointer { cursor: url('https://img.icons8.com/color/32/halloween-pumpkin.png'), pointer !important; }
        }

        /* =================================================================
           ‚ù§Ô∏è TH√àME SAINT-VALENTIN : MODE "CALME & CHIC" (100% Fixe)
           ================================================================= */
        .theme-love body { 
            background: linear-gradient(to bottom, #fff1f2, #ffe4e6) !important; 
            color: #881337 !important;
        }

        /* Cartes fixes et propres */
        .theme-love .bg-white, .theme-love .bg-slate-50 { 
            background-color: #fff !important;
            border: 1px solid #fecdd3 !important;
            box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1); /* Ombre l√©g√®re rose */
            color: #4c0519 !important;
        }

        /* Textes */
        .theme-love .text-slate-800 { color: #881337 !important; }
        .theme-love .text-slate-500 { color: #9f1239 !important; }
        
        /* Boutons fixes (Pas de battement de coeur) */
        .theme-love .bg-blue-600, .theme-love .bg-slate-900 { 
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important; 
            border: none;
            box-shadow: 0 4px 6px rgba(190, 18, 60, 0.2);
        }
        
        /* Survol simple (Juste un changement de couleur, pas de mouvement) */
        .theme-love .bg-blue-600:hover { 
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%) !important; 
        }

        /* Accents */
        .theme-love .text-blue-600 { color: #db2777 !important; }
        .theme-love .bg-blue-50 { background-color: #fff1f2 !important; border-color: #fda4af !important; }

        /* Logo fixe */
        .theme-love .sidebar-logo {
            background: linear-gradient(to bottom right, #fb7185, #be123c) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.2);
        }

        /* Curseur standard (pour √©viter la fatigue visuelle) */
        @media (min-width: 768px) {
            .theme-love * { cursor: auto !important; }
            .theme-love .cursor-pointer { cursor: pointer !important; }
        }

        /* =================================================================
           üéÜ 14 JUILLET : MODE "R√âPUBLIQUE" (√âl√©gance Tricolore)
           ================================================================= */
        .theme-bastille body { background-color: #f1f5f9 !important; }

        /* Boutons Patriotiques (D√©grad√© Bleu Blanc Rouge subtil) */
        .theme-bastille .bg-blue-600, .theme-bastille .bg-slate-900 { 
            background: linear-gradient(90deg, #1e3a8a 0%, #1d4ed8 50%, #dc2626 100%) !important; 
            background-size: 200% auto;
            transition: 0.5s;
            border: 1px solid #fff;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
        }
        .theme-bastille .bg-blue-600:hover { background-position: right center !important; }

        /* Titres en Bleu Roi */
        .theme-bastille .text-slate-800 { color: #1e3a8a !important; }
        
        /* Logo qui √©tincelle */
        .theme-bastille .sidebar-logo {
            background: #dc2626 !important;
            animation: fireworks-flash 2s infinite;
        }
        @keyframes fireworks-flash {
            0%, 100% { box-shadow: 0 0 5px #1e3a8a; }
            50% { box-shadow: 0 0 20px #dc2626, 0 0 40px #fff; }
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-bastille * { cursor: url('https://img.icons8.com/color/32/france.png'), auto !important; }
            .theme-bastille .cursor-pointer { cursor: url('https://img.icons8.com/color/32/firework.png'), pointer !important; }
        }

        /* =================================================================
           ‚òÄÔ∏è √âT√â / VACANCES : MODE "LAGON" (Fra√Æcheur & Soleil)
           ================================================================= */
        .theme-summer body { background-color: #ecfeff !important; } /* Cyan tr√®s p√¢le */

        /* Boutons "Mojito" (D√©grad√© Cyan/Jaune) */
        .theme-summer .bg-blue-600 { 
            background: linear-gradient(135deg, #06b6d4 0%, #f59e0b 100%) !important; 
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        .theme-summer .bg-blue-600:hover { transform: rotate(-2deg) scale(1.05); }

        /* Cartes lumineuses */
        .theme-summer .bg-white { border-bottom: 4px solid #f59e0b !important; }

        /* Textes "Mer des Cara√Øbes" */
        .theme-summer .text-blue-600 { color: #0891b2 !important; }
        
        /* Logo Soleil qui tourne */
        .theme-summer .sidebar-logo {
            background: linear-gradient(to bottom, #f59e0b, #ea580c) !important;
            animation: spin-slow 20s linear infinite;
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-summer * { cursor: url('https://img.icons8.com/color/32/sun--v1.png'), auto !important; }
            .theme-summer .cursor-pointer { cursor: url('https://img.icons8.com/color/32/melting-ice-cream.png'), pointer !important; }
        }
    </style>
</head>
<body>

<div id="app" :class="currentTheme.classes" class="h-screen flex flex-col overflow-hidden text-slate-800 transition-colors duration-500">
   <div class="pointer-events-none fixed inset-0 z-[100] overflow-hidden">
        
        <div v-if="currentTheme.name === 'christmas'">
            <div v-for="n in 50" :key="n" class="snowflake" :style="{ left: Math.random()*100 + 'vw', animationDuration: (Math.random()*5+5)+'s', animationDelay: '-'+Math.random()*5+'s', fontSize: (Math.random()*10+10)+'px' }">‚ùÑ</div>
            <div class="absolute bottom-[-20px] right-[-10px] opacity-20 text-9xl transform rotate-12">üéÑ</div>
        </div>

        <div v-if="currentTheme.name === 'halloween'">
            
            <div class="absolute top-[-20px] right-[-20px] opacity-20 text-[150px] pointer-events-none text-slate-500 rotate-12">üï∏Ô∏è</div>
            
            <div v-for="n in 6" :key="n" class="absolute text-3xl opacity-30" 
                 :style="{ 
                     left: Math.random()*100 + 'vw', 
                     top: Math.random()*60 + 'vh', 
                     animation: 'float-ghost ' + (Math.random()*5+5) + 's ease-in-out infinite',
                     fontSize: (Math.random()*20+20)+'px'
                 }">
                 ü¶á
            </div>
            <div v-if="currentTheme.name === 'bastille'">
            <div v-for="n in 5" :key="n" class="absolute w-2 h-2 rounded-full animate-ping" 
                 :style="{ 
                    left: Math.random()*100 + 'vw', 
                    top: Math.random()*50 + 'vh', 
                    backgroundColor: ['#1e3a8a', '#dc2626', '#ffffff'][Math.floor(Math.random()*3)],
                    animationDuration: '1s', 
                    animationDelay: Math.random()+'s' 
                 }"></div>
             <div class="absolute bottom-4 right-4 opacity-20 text-8xl">üá´üá∑</div>
        </div>
        

            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-purple-900/20 to-transparent pointer-events-none"></div>
        </div>

       <div v-if="currentTheme.name === 'love'">
            <div class="absolute bottom-[-30px] right-[-20px] opacity-10 text-[180px] pointer-events-none grayscale-[0.2] rotate-[-15deg]">üåπ</div>
        </div>

        <div v-if="currentTheme.name === 'summer'">
            <div class="sun-ray"></div> <div class="absolute top-[-50px] right-[-50px] text-9xl text-yellow-400 opacity-20 animate-spin-slow" style="animation-duration: 20s;">‚òÄÔ∏è</div>
            <div class="absolute bottom-10 left-10 text-6xl opacity-10">üç¶</div>
        </div>

        <div v-if="currentTheme.name === 'newyear'">
            <div v-for="n in 40" :key="n" class="confetti" :style="{ left: Math.random()*100 + 'vw', top: '-10px', backgroundColor: ['#FFD700', '#C0C0C0', '#000'][Math.floor(Math.random()*3)], animationDuration: (Math.random()*3+2)+'s' }"></div>
        </div>

    </div>
    <div v-if="!user.logged" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-4">
        
        <div v-if="!loginAdminSelection" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center fade-in relative overflow-hidden">
            
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl mx-auto mb-6 shadow-lg shadow-blue-500/30 relative z-10">
                <i class="fa-solid fa-address-book"></i>
            </div>
            
            <h1 class="text-2xl font-bold mb-6 relative z-10">Connexion CRM</h1>
            
            <div class="space-y-4 relative z-10">
                <input type="text" v-model="loginEmail" @keyup.enter="login" placeholder="Identifiant / Email" autocomplete="username" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg mb-2 outline-none focus:border-blue-600 transition">
                <input type="password" v-model="loginPass" @keyup.enter="login" placeholder="Mot de passe" autocomplete="current-password" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg tracking-widest outline-none focus:border-blue-600 transition">
            </div>

            <button @click="login" class="relative z-10 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition transform active:scale-95 mt-6 mb-2">Se connecter</button>
            <div class="mt-4 text-xs text-gray-400 relative z-10">Acc√®s s√©curis√©</div>
        </div>

        <div v-else class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center pop-in">
            <h2 class="text-xl font-bold mb-6 text-slate-700">Qui se connecte ?</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button v-for="name in adminNamesList" :key="name" @click="finalizeAdminLogin(name)" class="p-4 bg-slate-100 hover:bg-blue-100 border-2 border-transparent hover:border-blue-500 rounded-xl font-bold text-slate-700 hover:text-blue-700 transition flex flex-col items-center gap-2">
                    <i class="fa-solid fa-user-tie text-2xl"></i>
                    {{ name }}
                </button>
            </div>
            <button @click="loginAdminSelection=false" class="text-gray-400 hover:text-gray-600 underline text-sm">Retour</button>
        </div>
    </div>

    <div v-else class="flex flex-1 h-full relative">
        
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen=false" class="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm"></div>

        <aside :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" class="fixed md:relative w-64 bg-white shadow-xl flex flex-col z-40 h-full transition-transform duration-300 ease-in-out">
            <div class="p-6 border-b flex items-center gap-3">
             <div class="sidebar-logo w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold flex-shrink-0 transition-all duration-500">
    <i v-if="currentTheme.name === 'christmas'" class="fa-solid fa-tree text-lg"></i>
    
    <i v-else-if="currentTheme.name === 'love'" class="fa-solid fa-heart text-xl text-white"></i>

    <i v-else-if="currentTheme.name === 'halloween'" class="fa-solid fa-hat-wizard text-lg"></i>

    <i v-else-if="currentTheme.name === 'bastille'" class="fa-solid fa-flag-usa text-lg"></i>

    <i v-else-if="currentTheme.name === 'newyear'" class="fa-solid fa-champagne-glasses text-lg"></i>

    <i v-else-if="currentTheme.name === 'summer'" class="fa-solid fa-sun text-lg"></i>

    <i v-else class="fa-solid fa-calendar-check"></i>
</div>
                <div class="min-w-0">
                    <h1 class="font-bold text-lg leading-tight truncate">RDV Manager</h1>
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase font-bold truncate block">{{ user.name }}</span>
                </div>
                <button @click="mobileMenuOpen=false" class="ml-auto md:hidden text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="changeView('dashboard'); mobileMenuOpen=false" :class="view==='dashboard'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Tableau de bord</button>
                <button @click="changeView('list'); mobileMenuOpen=false" :class="view==='list'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-address-book w-5 text-center"></i> Tous les RDV</button>
                <button @click="changeView('rappels'); mobileMenuOpen=false" :class="{'border-red-300 bg-red-50 text-red-600': rappelCount > 0}" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border border-transparent hover:bg-gray-50 transition mt-4"><i class="fa-solid fa-bell w-5 text-center"></i> Rappels <span v-if="rappelCount>0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ rappelCount }}</span></button>
                <button v-if="pendingStatusCount > 0" @click="changeView('pending_status'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-purple-100 border border-purple-300 text-purple-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-clipboard-question w-5 text-center"></i> Statuts √† d√©finir <span class="ml-auto bg-purple-600 text-white text-xs px-2 py-1 rounded-full">{{ pendingStatusCount }}</span></button>
                <button v-if="confirmCount > 0" @click="changeView('confirmations'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-orange-100 border border-orange-300 text-orange-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation w-5 text-center"></i> √Ä Confirmer <span class="ml-auto bg-orange-600 text-white text-xs px-2 py-1 rounded-full">{{ confirmCount }}</span></button>
            </nav>

            <div class="p-4 border-t space-y-2">
                <button @click="changeView('trash'); mobileMenuOpen=false" :class="view==='trash'?'bg-gray-100 text-gray-800 font-bold':'text-gray-400 hover:text-gray-600 hover:bg-gray-50'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 transition"><i class="fa-solid fa-trash-can w-5 text-center"></i> Corbeille <span v-if="trashCount > 0" class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">{{ trashCount }}</span></button>
            </div>

            <div class="p-4 border-t space-y-2">
                <button v-if="user.role==='admin'" @click="openSettings(); mobileMenuOpen=false" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-600 hover:bg-slate-100 transition font-bold"><i class="fa-solid fa-gear w-5 text-center"></i> R√©glages</button>
                <button @click="logout" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-red-400 hover:text-red-600 hover:bg-red-50 transition font-bold"><i class="fa-solid fa-power-off w-5 text-center"></i> D√©connexion</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#f8fafc] relative overflow-hidden h-full">
           <header class="bg-white/80 backdrop-blur-sm p-4 shadow-sm flex justify-between items-center z-10 border-b border-slate-200 relative overflow-hidden transition-colors duration-500" :class="currentTheme.name === 'christmas' ? 'border-red-200 bg-red-50/80' : ''">
    
    <div class="flex items-center gap-2 md:gap-3">
        <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-10 h-10 bg-white border border-slate-200 rounded-xl text-slate-700 shadow-sm flex items-center justify-center hover:bg-slate-50 transition transform active:scale-95 flex-shrink-0">
            <i class="fa-solid fa-bars"></i>
        </button>

        <button @click="startWizard" class="bg-slate-900 hover:bg-slate-800 text-white px-3 md:px-6 py-2.5 rounded-full font-bold shadow-lg flex items-center gap-2 transform active:scale-95 transition text-xs md:text-base flex-shrink-0">
            <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Nouveau RDV</span><span class="md:hidden">Nouveau</span>
        </button>
        
        <div v-if="currentTheme.name !== 'default'" class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1 rounded-full bg-white shadow-sm border border-slate-100 animate-fadeIn whitespace-nowrap overflow-hidden max-w-[120px] md:max-w-none">
            <span class="text-base md:text-lg">{{ currentTheme.icon }}</span>
            <span class="text-[10px] md:text-xs font-bold text-slate-600 truncate">{{ currentTheme.label }}</span>
        </div>
    </div>

    <!-- ADMIN CA (MODIFI√â POUR MARGE NETTE + CA JOUR) -->
    <div v-if="user.role==='admin'" class="bg-white border border-slate-100 px-3 md:px-4 py-1 md:py-2 rounded-xl text-right ml-auto flex-shrink-0 flex items-center gap-3 md:gap-4 shadow-sm overflow-x-auto max-w-[50vw] hide-scrollbar">
        <div class="flex flex-col items-end border-r pr-3 border-slate-100 flex-shrink-0">
             <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">CA Jour</p>
             <p class="text-xs font-black text-slate-600 leading-none">{{ formatPrice(stats.ca_daily) }}</p>
        </div>
        <div class="hidden md:flex flex-col items-end border-r pr-3 border-slate-100 flex-shrink-0">
             <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">CA Brut</p>
             <p class="text-xs font-bold text-slate-500 leading-none">{{ formatPrice(stats.ca) }}</p>
        </div>
        <div class="flex flex-col items-end border-r pr-3 border-slate-100 flex-shrink-0">
             <p class="text-[9px] font-bold text-orange-400 uppercase tracking-wider">Commissions</p>
             <p class="text-xs font-bold text-orange-500 leading-none">-{{ formatPrice(stats.commissions) }}</p>
        </div>
        <div class="flex flex-col items-end flex-shrink-0">
            <p class="text-[9px] text-green-600 font-bold uppercase tracking-wider flex items-center justify-end gap-1"><i class="fa-solid fa-wallet"></i> <span class="hidden md:inline">Marge</span></p>
            <div class="flex flex-col items-end">
                <p class="text-sm md:text-xl font-black text-green-700 leading-none">{{ formatPrice(stats.net) }}</p>
            </div>
        </div>
    </div>

    <!-- COMMERCIAL COMMISSION (NOUVEAU) -->
    <div v-else-if="userCommissionStats" class="bg-blue-50 border border-blue-200 px-3 py-1.5 rounded-xl text-right ml-auto flex-shrink-0 shadow-sm relative group cursor-help">
        <p class="text-[9px] text-blue-600 font-bold uppercase tracking-wider flex items-center justify-end gap-1"><i class="fa-solid fa-trophy"></i> Ma Prime</p>
        <div class="flex flex-col items-end">
            <p class="text-sm md:text-lg font-black text-blue-700 leading-none">{{ formatPrice(userCommissionStats.totalEarnings) }}</p>
            <p class="text-[10px] font-bold text-blue-500 leading-none mt-0.5">{{ userCommissionStats.count }} RDV Honor√©s</p>
        </div>
        
        <!-- TOOLTIP DETAIL -->
        <div class="absolute top-full right-0 mt-2 bg-white border border-slate-200 p-3 rounded-xl shadow-xl w-48 hidden group-hover:block z-50 text-xs text-left">
            <div class="flex justify-between mb-1"><span class="text-slate-500">Base:</span> <span class="font-bold">{{ formatPrice(userCommissionStats.baseEarnings) }}</span></div>
            <div class="flex justify-between mb-1"><span class="text-green-500">Bonus Palier:</span> <span class="font-bold text-green-600">+{{ formatPrice(userCommissionStats.bonusEarnings) }}</span></div>
            <div class="flex justify-between border-t pt-1 mt-1"><span class="text-purple-500">Pourboires:</span> <span class="font-bold text-purple-600">+{{ formatPrice(userCommissionStats.tipEarnings) }}</span></div>
        </div>

        <!-- Notification Palier Atteint -->
        <div v-if="userCommissionStats.justReachedTier" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></div>
        <div v-if="userCommissionStats.bonusEarnings > 0" class="absolute top-0 left-0 -mt-2 -ml-2 bg-yellow-400 text-white text-[10px] font-bold px-1.5 rounded-full shadow-sm animate-bounce">üöÄ</div>
    </div>

</header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6">
                <div v-if="view==='dashboard'" class="space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row gap-6 mb-6 items-stretch">
                        <div class="flex-1 flex flex-col md:flex-row md:items-center gap-3">
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 uppercase tracking-tight">{{ currentFullDateLabel }}</h2>
                            
                           
                        </div>
                        <div @click="openStatsModal" class="cursor-pointer hover:scale-[1.02] transition-transform bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex items-center gap-4 min-w-[300px] relative overflow-hidden" :class="conversionRateColor"><div class="absolute inset-0 bg-white opacity-80 z-0"></div><div class="z-10 text-5xl emoji-bounce filter drop-shadow-md">{{ conversionEmoji }}</div><div class="z-10 flex-1"><p class="text-xs font-bold uppercase tracking-widest opacity-60">Taux de conversion</p><div class="flex items-baseline gap-2"><span class="text-4xl font-black">{{ conversionRate }}%</span><span class="text-xs font-medium opacity-70">Honor√©s / Total</span></div><div class="w-full bg-black/10 h-1.5 rounded-full mt-1 overflow-hidden"><div class="h-full bg-black/50 transition-all duration-1000" :style="{width: conversionRate + '%'}"></div></div></div></div>
                    </div>
                   <!-- 4 COLONNES POUR AJOUTER LES ANNUL√âS -->
                   <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                        <div @click="showUpcoming" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-blue-500">√Ä venir</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.upcoming }}</p></div>
                                <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 text-xl group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-calendar-days"></i></div>
                            </div>
                        </div>
                        <div @click="showHonored" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-green-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-green-600">Honor√©s</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.honored }}</p></div>
                                <div class="w-12 h-12 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 text-xl group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-check"></i></div>
                            </div>
                        </div>
                        <div @click="showNoShow" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-red-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-red-600">Pas Venus</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.noshow }}</p></div>
                                <div class="w-12 h-12 bg-red-50 rounded-2xl flex items-center justify-center text-red-600 text-xl group-hover:bg-red-600 group-hover:text-white transition"><i class="fa-solid fa-user-xmark"></i></div>
                            </div>
                        </div>
                        <!-- NOUVELLE CARTE ANNUL√âS -->
                        <div @click="showCancelled" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-gray-400 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-gray-600">Annul√©s</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.cancelled }}</p></div>
                                <div class="w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center text-gray-500 text-xl group-hover:bg-gray-500 group-hover:text-white transition"><i class="fa-solid fa-ban"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-4 md:p-8">
<div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                           <h2 class="text-xl font-bold flex items-center gap-3 text-slate-800">
    <i class="fa-regular fa-clock text-blue-500"></i>

    <span>Timeline Aujourd'hui</span>

    <span
        class="text-xs md:text-sm font-semibold text-slate-600 bg-slate-100 px-2.5 py-1 rounded-full border border-slate-200 flex items-center gap-1"
    >
        <i class="fa-solid fa-calendar-day text-slate-400"></i>
        {{ rdvTodayCount }} RDV
    </span>
</h2>
                            
                            <div class="flex flex-wrap gap-2 w-full xl:w-auto">
                                <select v-model="dashboardFilters.agencyId" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:border-blue-500 shadow-sm">
                                    <option value="">Toutes les agences</option>
                                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                </select>

                                <select v-if="user.role === 'admin'" v-model="dashboardFilters.userId" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:border-blue-500 shadow-sm">
                                    <option value="">Toute l'√©quipe</option>
                                    <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                                </select>

                              <button @click="dashboardFilters.onlyLive = !dashboardFilters.onlyLive" 
                                        :class="dashboardFilters.onlyLive ? 'bg-green-500 text-white shadow-green-200 shadow-md' : (activeRdvCount > 0 ? 'bg-green-50 text-green-600 border-green-200' : 'bg-white text-slate-400 border-slate-200')"
                                        class="px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 border">
                                    <span :class="activeRdvCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-slate-300'" class="w-2 h-2 rounded-full block"></span>
                                    {{ activeRdvCount }} En cours
                                </button>
                            </div>
                        </div>                        <div class="space-y-4 relative"><div class="absolute left-[35px] top-4 bottom-4 w-0.5 bg-slate-100 z-0"></div>
                            <div v-for="rdv in sortedDaily" :key="rdv.id" @click="openRdvFiche(rdv)" :class="isEnCours(rdv) ? 'live-animation' : ''" class="relative z-10 flex flex-col md:flex-row md:items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:border-blue-200 hover:shadow-lg cursor-pointer transition group gap-2 md:gap-0 overflow-hidden">
                                
                                <div class="flex items-center w-full md:w-auto relative z-10">
                                    <div class="w-16 md:w-20 font-bold text-lg text-slate-500 group-hover:text-blue-600 transition text-center bg-white rounded-xl py-2 mr-4 shadow-sm border border-slate-100 flex-shrink-0">{{ rdv.heure }}</div>
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i></div>
                                </div>
                                <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                                    <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                                        {{ rdv.civilite }} {{ rdv.nom }} 
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span>
                                        <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                                        <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                            -{{ rdv.geste_commercial }}‚Ç¨
                                        </span>
                                    </div>
                                    <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                                        <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                                    </div>
                                    <div class="text-sm text-slate-500 flex flex-wrap items-center gap-2 md:gap-3 mt-1 font-medium">
                                       <span class="bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-600">
    <i class="fa-solid fa-car text-slate-400"></i> {{ rdv.modele }}
</span>

<span class="flex items-center gap-1 text-xs opacity-70">
    <img :src="getLogo(rdv.source)" class="w-4 h-4 rounded-sm">
    {{ rdv.source }}
</span>

<span
    v-if="getRelativeRdvLabel(rdv)"
    class="text-[11px] font-bold text-orange-500 uppercase"
>
    {{ getRelativeRdvLabel(rdv) }}
</span>

<div class="w-full mt-1 flex flex-wrap gap-2">
                                            <span class="text-[10px] font-bold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                                                <i class="fa-solid fa-building"></i> {{ getAgenceName(rdv.agenceId) }}
                                            </span>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                                <i class="fa-solid fa-user-tag"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10">
                                    <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                                    <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                                    <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                                    <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                                </div>
                            </div>
                           <div v-if="filteredDaily.length > dashboardLimit" class="text-center pt-4 border-t mt-2">
                            <button @click="dashboardLimit += 15" class="bg-white border border-slate-200 text-slate-500 px-6 py-2 rounded-full text-sm font-bold hover:bg-slate-50 hover:text-blue-600 hover:border-blue-200 transition shadow-sm">
                                üëá Voir la suite ({{ filteredDaily.length - dashboardLimit }} de plus)
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

               <div v-if="view==='list'" class="bg-white rounded-[32px] shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative transition-all duration-500 font-sans">
    
    <div class="bg-white border-b border-slate-100 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)]">
        
        <div class="flex-1 w-full md:w-auto flex items-center gap-4">
            <!-- BOUTON RETOUR INTELLIGENT -->
            <button v-if="currentFilter !== 'all' || listFilters.agenceId || listFilters.date || listFilters.prospecteur || fromDashboard" @click="goBackFromList" class="bg-slate-100 text-slate-500 hover:bg-blue-50 hover:text-blue-600 w-10 h-10 rounded-full flex items-center justify-center transition-all group" title="Retour">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i>
            </button>
            
            <div class="relative flex-1 max-w-md group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                <input 
                    v-model="search" 
                    placeholder="Rechercher client, v√©hicule, t√©l..." 
                    class="w-full pl-12 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white focus:shadow-md transition-all"
                >
                <button v-if="search" @click="search=''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 transition">
                    <i class="fa-solid fa-circle-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-center md:justify-end">
            
            <button @click="currentFilter = (currentFilter==='upcoming'?'all':'upcoming')" :class="currentFilter==='upcoming' ? 'bg-blue-600 text-white shadow-blue-200 shadow-md' : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600'" class="px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 active:scale-95">
                <i class="fa-solid fa-clock"></i> √Ä venir
            </button>

            <button @click="currentFilter = (currentFilter==='live'?'all':'live')" :class="currentFilter==='live' ? 'bg-green-500 text-white shadow-green-200 shadow-md' : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-green-50 hover:border-green-200 hover:text-green-600'" class="px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 active:scale-95 group">
                <i class="fa-solid fa-clock fa-spin" style="animation-duration: 3s;"></i> 
                En cours ({{ activeRdvCount }})
            </button>

            <div class="relative">
                <select v-model="listFilters.agenceId" class="appearance-none bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-700 font-bold text-sm rounded-full pl-4 pr-8 py-2 outline-none cursor-pointer transition focus:border-blue-500">
                    <option value="">üè¢ Toutes agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
            </div>

             <input type="date" v-model="listFilters.date" class="appearance-none bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-700 font-bold text-sm rounded-full px-4 py-2 outline-none cursor-pointer transition focus:border-blue-500" title="Filtrer par date">

             <button v-if="listFilters.agenceId || listFilters.date || listFilters.prospecteur || currentFilter !== 'all'" @click="resetListFilters" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition" title="Effacer tous les filtres">
                <i class="fa-solid fa-xmark"></i>
             </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative">
        
        <div v-if="filteredList.length === 0" class="flex flex-col items-center justify-center h-full fade-in pb-20">
            <div v-if="!search && currentFilter === 'all' && !listFilters.agenceId && !listFilters.date" class="text-center max-w-md">
                <div class="mb-6 p-8 bg-white rounded-[3rem] shadow-xl shadow-blue-50 inline-block animate-bounce-slow relative">
                    <div class="absolute inset-0 bg-blue-500 opacity-10 blur-2xl rounded-full"></div>
                    <i class="fa-solid fa-magnifying-glass-location text-6xl text-blue-500 relative z-10"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-3">Explorez vos RDV</h2>
                <p class="text-slate-500 font-medium text-lg leading-relaxed mb-8">Utilisez la recherche ou les filtres rapides ci-dessus.</p>
                <button @click="showUpcoming" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:scale-105 transition-all transform flex items-center gap-3 mx-auto">
                    <i class="fa-regular fa-calendar-check text-xl"></i>
                    Voir les prochains RDV
                </button>
            </div>
            <div v-else class="text-center text-slate-400 opacity-70">
                 <i class="fa-regular fa-face-frown-open text-6xl mb-4"></i>
                 <p class="font-bold text-xl">Aucun rendez-vous trouv√©.</p>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4 px-2">
                 <h3 class="font-bold text-slate-700 text-lg">R√©sultats</h3>
                 <span class="text-xs font-black text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">{{ filteredList.length }} RDV trouv√©(s)</span>
            </div>

            <!-- MODIFICATION DESIGN : AFFICHAGE EN LIGNE COMME LE DASHBOARD -->
            <div class="space-y-4 pb-24 md:pb-0">
                <div v-for="rdv in displayedList" :key="rdv.id" @click="openRdvFiche(rdv)" :class="isEnCours(rdv) ? 'live-animation' : ''" class="relative z-10 flex flex-col md:flex-row md:items-center p-4 bg-white rounded-2xl border border-slate-100 hover:border-blue-200 hover:shadow-lg cursor-pointer transition group gap-2 md:gap-0 overflow-hidden">
                    
                    <!-- Selection Checkbox -->
                    <div v-if="user.role==='admin'" class="absolute top-2 right-2 md:top-auto md:bottom-auto md:left-2 md:right-auto md:relative md:mr-4 z-50" @click.stop>
                         <input type="checkbox" class="custom-checkbox w-5 h-5 shadow-sm border-2 border-slate-300 rounded" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                    </div>

                    <div class="flex items-center w-full md:w-auto relative z-10">
                        <!-- Affichage Date & Heure Group√© -->
                        <div class="flex flex-col items-center bg-slate-50 rounded-xl py-2 px-3 mr-4 shadow-sm border border-slate-100 flex-shrink-0 min-w-[80px]">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">{{ formatDateShort(rdv.date) }}</span>
                            <span class="font-black text-lg text-slate-600 group-hover:text-blue-600 transition">{{ rdv.heure }}</span>
                        </div>
                        
                        <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i></div>
                    </div>

                    <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                        <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                            {{ rdv.civilite }} {{ rdv.nom }} 
                            <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                            <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span>
                            <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                            <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                -{{ rdv.geste_commercial }}‚Ç¨
                            </span>
                        </div>
                        
                        <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                            <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                        </div>

                        <div class="text-sm text-slate-500 flex flex-wrap items-center gap-2 md:gap-3 mt-1 font-medium">
                           <span class="bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-600">
                                <i class="fa-solid fa-car text-slate-400"></i> {{ rdv.modele }}
                            </span>
                            <span class="flex items-center gap-1 text-xs opacity-70">
                                <i class="fa-solid fa-phone text-[10px]"></i> {{ rdv.telephone }}
                            </span>
                            <span class="flex items-center gap-1 text-xs opacity-70">
                                <img :src="getLogo(rdv.source)" class="w-4 h-4 rounded-sm"> {{ rdv.source }}
                            </span>
                            <span v-if="getRelativeRdvLabel(rdv)" class="text-[11px] font-bold text-orange-500 uppercase">
                                {{ getRelativeRdvLabel(rdv) }}
                            </span>
                            
                            <div class="w-full mt-1 flex flex-wrap gap-2">
                                <span class="text-[10px] font-bold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                                    <i class="fa-solid fa-building"></i> {{ getAgenceName(rdv.agenceId) }}
                                </span>
                                <span class="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                    <i class="fa-solid fa-user-tag"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10">
                        <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                        <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                        <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                        <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>

            <div v-if="displayedList.length < filteredList.length" class="p-8 text-center">
                 <button @click="displayLimit += 20" class="bg-white border-2 border-slate-200 text-slate-500 px-8 py-3 rounded-full font-bold hover:bg-slate-50 hover:border-blue-300 hover:text-blue-600 transition shadow-sm active:scale-95">üëá Charger les suivants</button>
            </div>
        </div>
    </div>

    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-auto bg-slate-900 text-white p-4 rounded-full shadow-2xl flex items-center justify-between gap-6 slide-up z-[60] border border-slate-800">
        <div class="font-bold pl-2 flex items-center gap-2"><span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">{{ selectedIds.length }}</span> <span class="hidden md:inline">s√©lectionn√©s</span></div>
        <div class="flex gap-2">
            <button @click="openBulkConfirm('soft_delete', 'Mettre √† la corbeille ?')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-red-500/30 active:scale-95">
                <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">Corbeille</span>
            </button>
            <button @click="selectedIds=[]" class="text-slate-400 hover:text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-800 transition" title="Annuler la s√©lection">‚úï</button>
        </div>
    </div>
</div>

    <!-- üîª le reste de la liste (table + mobile) NE BOUGE PAS -->
 <div v-if="view==='trash'" class="bg-white rounded-3xl shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative">
                    
                    <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-700"><i class="fa-solid fa-trash-can"></i> Corbeille</h2>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500">{{ trashList.length }} √©l√©ments</span>
                            <button v-if="trashList.length > 0 && user.role==='admin'" @click="openBulkConfirm('empty_trash', 'Vider TOUTE la corbeille ?')" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition">Tout Vider</button>
                        </div>
                    </div>

                    <div class="overflow-auto flex-1 p-0 pb-20 hidden md:block">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10 shadow-sm font-bold">
                                <tr>
                                    <th class="p-4 w-10"><input type="checkbox" class="custom-checkbox" @change="selectAll($event)" :checked="isAllSelected && trashList.length > 0"></th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Client</th>
                                    <th class="p-4 hidden md:table-cell">Supprim√© par</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr v-for="rdv in trashList" :key="rdv.id" class="border-b hover:bg-red-50 transition" :class="{'bg-red-50': selectedIds.includes(rdv.id)}">
                                    <td class="p-4 text-center"><input type="checkbox" class="custom-checkbox" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)"></td>
                                    <td class="p-4 text-gray-400"><div class="font-bold line-through">{{ formatDateShort(rdv.date) }}</div></td>
                                    <td class="p-4 opacity-50"><div class="font-bold">{{ rdv.nom }}</div><div>{{ rdv.modele }}</div></td>
                                    <td class="p-4 text-xs font-bold text-gray-400 uppercase hidden md:table-cell">Utilisateur</td>
                                    <td class="p-4 text-right flex justify-end gap-2">
                                        <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition" title="Restaurer"><i class="fa-solid fa-rotate-left"></i></button>
                                        <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition" title="Supprimer d√©finitivement"><i class="fa-solid fa-ban"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="md:hidden flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-100">
                        <div v-for="rdv in trashList" :key="rdv.id" 
                             class="p-4 rounded-2xl shadow-sm border relative transition-all duration-200"
                             :class="selectedIds.includes(rdv.id) ? 'bg-red-50 border-red-300 ring-1 ring-red-200' : 'bg-white border-red-100'">
                            
                            <div class="absolute top-4 right-4 z-10">
                                <input type="checkbox" class="custom-checkbox w-6 h-6" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                            </div>

                            <div class="flex justify-between items-start mb-2 pr-8 opacity-60">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase flex items-center gap-1 line-through"><i class="fa-regular fa-calendar"></i> {{ formatDateShort(rdv.date) }}</div>
                                    <div class="text-lg font-bold text-slate-800">{{ rdv.nom }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-3 text-sm text-slate-600 font-medium opacity-60"><i class="fa-solid fa-car"></i> {{ rdv.modele }}</div>
                            
                            <div class="flex gap-2 justify-end mt-2 pt-2 border-t border-slate-100">
                                <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition">Restaurer</button>
                                <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition">Supprimer</button>
                            </div>
                        </div>
                        
                        <div v-if="trashList.length === 0" class="text-center text-gray-400 py-10 italic">La corbeille est vide.</div>
                    </div>

                    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-6 md:right-6 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between slide-up z-50 gap-3">
                        <div class="font-bold pl-2"><span class="text-blue-400 text-xl">{{ selectedIds.length }}</span> s√©lectionn√©s</div>
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button @click="openBulkConfirm('restore_trash', 'Restaurer la s√©lection ?')" class="bg-green-600 hover:bg-green-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Restaurer</button>
                            <button v-if="user.role==='admin'" @click="openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ?')" class="bg-red-600 hover:bg-red-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Supprimer</button>
                            <button @click="selectedIds=[]" class="ml-2 text-gray-400 hover:text-white px-2">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='pending_status'" class="max-w-3xl mx-auto space-y-4 fade-in"><h2 class="text-xl md:text-2xl font-bold mb-6 text-purple-700"><i class="fa-solid fa-clipboard-question"></i> Statuts √† d√©finir</h2><div v-if="pendingStatusList.length===0" class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"><i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>Tous les statuts sont √† jour !</div><div v-for="r in pendingStatusList" :key="r.id" class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 border-purple-500 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition group" @click="openRdvFiche(r)"><div class="cursor-pointer flex-1"><div class="font-bold text-lg flex items-center gap-2">{{ r.civilite }} {{ r.nom }} <span class="text-xs bg-gray-100 text-gray-500 px-2 rounded">Termin√©</span></div><div class="text-slate-500">{{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}</div><div class="text-sm font-bold text-blue-600 mt-1">{{ getAgenceName(r.agenceId) }}</div></div><div class="flex gap-2 w-full md:w-auto"><button @click.stop="updateStatus(r, 'honor_fact')" class="flex-1 md:flex-none bg-green-100 text-green-700 px-4 py-2 rounded-xl font-bold hover:bg-green-200 border border-green-200 text-sm"><i class="fa-solid fa-check"></i> Honor√©</button><button @click.stop="updateStatus(r, 'noshow')" class="flex-1 md:flex-none bg-red-100 text-red-700 px-4 py-2 rounded-xl font-bold hover:bg-red-200 border border-red-200 text-sm"><i class="fa-solid fa-user-xmark"></i> Lapin</button></div></div></div>
                <div v-if="view==='rappels' || view==='confirmations'" class="max-w-3xl mx-auto space-y-4 fade-in">
    <h2
        class="text-xl md:text-2xl font-bold mb-6"
        :class="view==='rappels' ? 'text-red-600' : 'text-orange-600'"
    >
        {{ view==='rappels' ? 'Rappels √† effectuer' : 'Rendez-vous √† confirmer' }}
    </h2>

    <!-- üî¥ Filtres internes uniquement pour l'onglet Rappels -->
    <div v-if="view==='rappels'" class="bg-white rounded-2xl border border-red-100 p-4 mb-2 shadow-sm space-y-3">
        <!-- Onglets Aujourd'hui / Demain (Veille) -->
        <div class="flex gap-2">
            <button
                @click="rappelFilters.day = 'today'"
                class="flex-1 px-3 py-2 rounded-full text-xs font-bold uppercase tracking-wide border transition"
                :class="rappelFilters.day === 'today'
                    ? 'bg-red-600 text-white border-red-600 shadow'
                    : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'"
            >
                Rappels Aujourd'hui <span v-if="rappelsJourCount > 0" class="ml-1 bg-white text-red-600 px-1.5 rounded-full text-[10px] shadow-sm">{{ rappelsJourCount }}</span>
            </button>
            <button
                @click="rappelFilters.day = 'tomorrow'"
                class="flex-1 px-3 py-2 rounded-full text-xs font-bold uppercase tracking-wide border transition"
                :class="rappelFilters.day === 'tomorrow'
                    ? 'bg-red-600 text-white border-red-600 shadow'
                    : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'"
            >
                Rappels Demain (Veille) <span v-if="rappelsVeilleCount > 0" class="ml-1 bg-white text-red-600 px-1.5 rounded-full text-[10px] shadow-sm">{{ rappelsVeilleCount }}</span>
            </button>
        </div>

        <!-- Filtres Agence / Cr√©√© par -->
        <div class="flex flex-wrap gap-2 items-center">
            <div class="relative">
                <select
                    v-model="rappelFilters.agenceId"
                    class="appearance-none bg-white border px-3 py-2 pr-8 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-red-500 shadow-sm"
                >
                    <option value="">Toutes les agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">
                        {{ ag.nom }}
                    </option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>

            <div class="relative">
                <select v-if="user.role === 'admin'"
                    v-model="rappelFilters.userId"
                    class="appearance-none bg-white border px-3 py-2 pr-8 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-red-500 shadow-sm"
                >
                    <option value="">Tous les utilisateurs</option>
                    <option v-for="u in allProspectors" :key="u" :value="u">
                        {{ u }}
                    </option>
                </select>
                <i v-if="user.role === 'admin'" class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>

            <button
                v-if="rappelFilters.day !== 'today' || rappelFilters.agenceId || rappelFilters.userId"
                @click="rappelFilters.day = 'today'; rappelFilters.agenceId=''; rappelFilters.userId='';"
                class="px-3 py-2 rounded-lg text-xs font-bold text-red-500 border border-red-200 bg-red-50 hover:bg-red-100 ml-auto"
            >
                R√©initialiser
            </button>
        </div>
    </div>

    <!-- Message "Tout est √† jour" -->
    <div
        v-if="(view==='rappels' && rappelsDisplay.length === 0) ||
               (view==='confirmations' && confirmList.length === 0)"
        class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"
    >
        <i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>
        Tout est √† jour !
    </div>

    <!-- Liste des rappels / confirmations -->
    <!-- AJOUT CLICK SUR LIGNE ET CLICK STOP SUR BOUTONS -->
    <div
        v-for="r in (view==='rappels' ? rappelsDisplay : confirmList)"
        :key="r.id"
        @click="openRdvFiche(r)"
        class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition gap-4 cursor-pointer"
        :class="view==='rappels' ? 'border-red-500' : 'border-orange-500'"
    >
        <div>
            <div class="font-bold text-lg">
                {{ r.civilite }} {{ r.nom }}
            </div>
            <div class="text-slate-500">
                {{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}
            </div>
            <div class="text-sm font-bold text-blue-600 mt-1">
                {{ getAgenceName(r.agenceId) }}
            </div>
        </div>

        <div class="flex flex-wrap gap-2 w-full md:w-auto" @click.stop>
            <a
                :href="generateMsgLink(r, view==='rappels' ? getRappelType(r) : 'confirm')"
                target="_blank"
                class="flex-1 md:flex-none justify-center bg-slate-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-900 flex items-center gap-2 shadow-lg shadow-slate-200"
            >
                <i class="fa-solid fa-comment-sms"></i>
                {{ view==='rappels' ? getRappelLabel(r) : 'SMS' }}
            </a>

            <button
                @click="validateAction(r, view)"
                class="bg-green-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-green-600 shadow"
            >
                <i class="fa-solid fa-check"></i>
            </button>

            <button
                v-if="view==='confirmations'"
                @click="quickCancel(r)"
                class="bg-white text-red-500 border border-red-200 px-4 py-2 rounded-xl font-bold hover:bg-red-50"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>
    
    <!-- FIX Z-INDEX MODALE CLIENT -->
    <div v-if="clientModal.open" class="fixed inset-0 bg-slate-900/60 z-[300] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg md:max-w-2xl rounded-[32px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] pop-in relative">
            <div v-if="getRdvTimeStatus(clientModal.rdv) === 'en_cours'" class="bg-green-500 text-white text-center py-1 font-bold text-xs uppercase tracking-widest animate-pulse shadow-lg">‚ö° En Cours ‚ö°</div>
            <div v-else-if="getRdvTimeStatus(clientModal.rdv) === 'bientot'" class="bg-orange-400 text-white text-center py-1 font-bold text-xs uppercase tracking-widest">‚ö†Ô∏è Arrive bient√¥t</div>
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-6 md:p-8 text-white relative">
                <!-- Bouton Fermer Modale (Am√©lior√©) -->
                <button @click="clientModal.open=false" class="absolute top-4 right-4 md:top-6 md:right-6 w-12 h-12 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition backdrop-blur-md z-50 cursor-pointer shadow-lg text-white font-bold text-xl">‚úï</button>
                <!-- NOUVEAU : Bouton Poubelle en haut √† droite -->
                 <button @click="softDeleteRdv(clientModal.rdv)" class="absolute top-4 right-16 md:top-6 md:right-20 w-12 h-12 bg-red-500/80 hover:bg-red-600 rounded-full flex items-center justify-center transition backdrop-blur-md z-50 cursor-pointer shadow-lg text-white font-bold text-lg" title="Mettre √† la corbeille"><i class="fa-solid fa-trash-can"></i></button>

                <div class="flex flex-col md:flex-row gap-6 items-center md:items-start text-center md:text-left">
                    <div :class="{'live-pulse border-green-400': getRdvTimeStatus(clientModal.rdv)==='en_cours'}" class="w-16 h-16 md:w-20 md:h-20 bg-white/10 border border-white/20 rounded-3xl flex items-center justify-center text-3xl font-bold backdrop-blur-sm shadow-xl transition-all duration-500">{{ clientModal.rdv.civilite === 'M.' ? 'M' : 'F' }}</div>
                    <div class="flex-1 w-full relative">
                        
                        <div class="text-2xl md:text-3xl font-bold text-white mb-1 flex items-center gap-3">
                            {{ clientModal.rdv.nom }} 
                            <!-- Bouton Crayon (D√©plac√© ici) -->
                            <button @click="openEdit(clientModal.rdv)" class="text-sm bg-white/20 hover:bg-white/30 text-white w-8 h-8 rounded-full flex items-center justify-center transition" title="Modifier infos client">
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                        </div>
                        <div class="font-mono text-lg md:text-xl text-blue-300 opacity-90">{{ clientModal.rdv.telephone }}</div>
                        
                        <div class="flex gap-3 mt-4 justify-center md:justify-start">
                            <a :href="'tel:' + normalizePhone(clientModal.rdv.telephone)" class="bg-green-500 hover:bg-green-600 text-white rounded-xl px-4 py-2 font-bold flex items-center gap-2 shadow-lg transform active:scale-95 transition text-sm"><i class="fa-solid fa-phone"></i> Appeler</a>
                            <a :href="generateMsgLink(clientModal.rdv, 'confirm')" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white rounded-xl px-4 py-2 font-bold flex items-center gap-2 shadow-lg transform active:scale-95 transition text-sm"><i class="fa-solid fa-paper-plane"></i> Renvoyer confirmation client</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 space-y-4 md:space-y-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span :class="statusClass(clientModal.rdv.statut)" class="px-4 py-1.5 rounded-lg text-xs font-black uppercase tracking-wide">{{ displayStatus(clientModal.rdv) }}</span>
                        <span v-if="clientModal.rdv.tag === 'OK M'" class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span>
                    </div>
                    <div class="text-xs md:text-sm font-bold">{{ getAgenceName(clientModal.rdv.agenceId) }}</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">V√©hicule</label>
                        <div class="text-lg font-bold text-slate-800">{{ clientModal.rdv.modele }}</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Source</label>
                        <div class="flex items-center gap-2">
                            <img v-if="clientModal.rdv.source" :src="getLogo(clientModal.rdv.source)" class="w-5 h-5 rounded">
                            <span class="font-bold text-slate-700">{{ clientModal.rdv.source }}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Date & Heure du RDV</label>
                        <div class="text-xl font-bold text-slate-800">{{ formatDateFr(clientModal.rdv.date) }} √† {{ clientModal.rdv.heure }}</div>
                    </div>
                    <button @click="openRescheduleModal(clientModal.rdv)" class="w-full md:w-auto bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-sm transition">üìÖ Reporter Rendez-vous</button>
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Notes & Historique</label>
                    
                    <div class="space-y-3 mb-4 max-h-[200px] overflow-y-auto">
                        <div v-if="clientModal.rdv.note && (!clientModal.rdv.notes || clientModal.rdv.notes.length === 0)" class="bg-yellow-50 p-3 rounded-xl text-sm text-slate-700 italic border border-yellow-100">
                            {{ clientModal.rdv.note }} <span class="text-xs text-yellow-400 block mt-1">(Ancienne note)</span>
                        </div>
                        <div v-for="(n, idx) in clientModal.rdv.notes" :key="idx" class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-sm flex justify-between items-start group">
                            <div>
                                <div class="flex justify-between items-start mb-1 gap-2">
                                    <span class="font-bold text-blue-800 text-xs">{{ n.author }}</span>
                                </div>
                                <div class="text-slate-700">{{ n.text }}</div>
                            </div>
                             <div class="flex flex-col items-end flex-shrink-0 ml-2">
                                 <span class="text-[10px] text-blue-400 whitespace-nowrap">{{ formatDateFr(n.date) }}</span>
                                 <!-- Bouton Supprimer Note (Croix Rouge en dessous de l'heure) -->
                                 <button @click="deleteNote(clientModal.rdv, idx)" class="text-red-400 hover:text-red-600 transition mt-1" title="Supprimer la note">
                                    <i class="fa-solid fa-xmark text-sm font-bold"></i>
                                </button>
                             </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input v-model="newNoteText" @keyup.enter="addNote" placeholder="Ajouter une note..." class="flex-1 bg-slate-50 p-3 rounded-xl text-sm border border-slate-200 outline-none focus:border-blue-500">
                        <button @click="addNote" class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-700"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="bg-slate-100 p-4 rounded-2xl">
                        <div class="flex gap-2 mb-2">
                            <button @click="openHonorCheck(clientModal.rdv)" class="flex-1 bg-white border border-green-200 text-green-700 py-2 rounded-lg text-xs font-bold shadow-sm">Honor√©</button>
                            <button @click="updateStatus(clientModal.rdv, 'noshow')" class="flex-1 bg-white border border-red-200 text-red-600 py-2 rounded-lg text-xs font-bold shadow-sm">Lapin</button>
                        </div>
                        <button v-if="['honore','pas_venu','annule'].includes(clientModal.rdv.statut)" @click="updateStatus(clientModal.rdv, 'reset')" class="w-full bg-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-300 transition"><i class="fa-solid fa-rotate-left"></i> R√©initialiser le statut</button>
                        
                        <div class="mt-4 border-t pt-4" v-if="user.role==='admin'">
                            <button @click="openDiscountModal" class="w-full py-3 rounded-xl font-bold text-sm shadow-sm border-2 border-red-200 bg-white text-red-500 flex items-center justify-center gap-2 transition hover:bg-red-50 hover:text-red-600">
                                <i class="fa-solid fa-gift text-xl"></i> üéÅ Faire un geste commercial
                            </button>
                            <div v-if="clientModal.rdv.geste_commercial" class="mt-2 text-center text-xs font-bold text-red-500">
                                Geste appliqu√© : -{{ clientModal.rdv.geste_commercial }}‚Ç¨ ({{ clientModal.rdv.motif_geste }})
                                <!-- BOUTON SUPPRIMER LE GESTE D√âPLAC√â ICI -->
                                <button @click="removeDiscount" class="ml-2 text-slate-400 hover:text-red-600 font-bold underline">Supprimer</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button @click="openCancelChoice(clientModal.rdv)" class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-bold hover:bg-red-100 transition">Annuler le RDV</button>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-white border-t flex justify-between items-center">
                <div class="text-[10px] text-gray-400 font-bold hidden md:block">
                    <div v-if="clientModal.rdv.created">Cr√©√© le {{ new Date(clientModal.rdv.created).toLocaleDateString('fr-FR') }} √† {{ new Date(clientModal.rdv.created).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) }}</div>
                    <div v-if="clientModal.rdv.createdBy">Par {{ clientModal.rdv.createdBy }}</div>
                </div>
                <button @click="updateRdv(clientModal.rdv)" class="w-full md:w-auto bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 shadow-xl transition transform active:scale-95">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- MODALE GESTE COMMERCIAL Z-INDEX FIX -->
    <div v-if="discountModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm pop-in border border-slate-200 relative">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h3 class="font-bold text-2xl mb-6 text-slate-800 text-center">Geste Commercial</h3>
            
            <div class="space-y-4">
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Montant (‚Ç¨)</label>
                     <input type="number" v-model.number="discountModal.amount" class="w-full p-4 border-2 border-red-100 rounded-xl font-black text-red-600 text-center text-2xl outline-none focus:border-red-400" placeholder="0">
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Motif</label>
                     <div class="grid grid-cols-1 gap-2 mb-2">
                         <button v-for="r in ['V√©hicule KO', 'Client pensait voir l\'acheteur', 'Autre']" 
                                 @click="discountModal.reason = r"
                                 :class="discountModal.reason === r ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                                 class="py-2 px-3 rounded-lg text-xs font-bold transition">
                             {{ r }}
                         </button>
                     </div>
                     <input v-if="discountModal.reason === 'Autre'" v-model="discountModal.customReason" placeholder="Pr√©cisez..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-red-400">
                </div>
                <!-- Message d'erreur int√©gr√© -->
                <p v-if="discountModal.error" class="text-red-500 text-xs font-bold text-center animate-shake">{{ discountModal.error }}</p>
            </div>

            <div class="flex gap-3 mt-8">
                 <button @click="discountModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Annuler</button>
                 <button @click="saveDiscount" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg transform active:scale-95">Valider</button>
            </div>
        </div>
    </div>

    <!-- MODALE STATUTS MANQUANTS (NOUVELLE) -->
    <div v-if="pendingStatusModal.open" class="fixed inset-0 bg-slate-900/90 z-[450] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-purple-100">
            <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-clipboard-question"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Statuts manquants</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-purple-600">{{ pendingStatusCount }} rendez-vous</strong> pass√©s dont le statut n'est pas √† jour.
            </p>
            
            <div class="space-y-3">
                <button @click="pendingStatusModal.open=false; changeView('pending_status')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition transform active:scale-95">
                    Voir les statuts
                </button>
                <button @click="pendingStatusModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>

    <!-- NOUVELLE MODALE ALERTE RAPPELS CONNEXION (LOGIQUE CORRIG√âE) Z-INDEX FIX -->
    <div v-if="reminderAlertModal.open" class="fixed inset-0 bg-slate-900/90 z-[400] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-red-100">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-bell"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rappels en attente</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-red-500" v-if="rappelsVeilleCount>0">{{ rappelsVeilleCount }} pour Demain</strong>
                <span v-if="rappelsVeilleCount>0 && rappelsJourCount>0"> et </span>
                <strong class="text-red-500" v-if="rappelsJourCount>0">{{ rappelsJourCount }} pour Aujourd'hui</strong>.
            </p>
            
            <div class="space-y-3">
                <button @click="reminderAlertModal.open=false; changeView('rappels')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition transform active:scale-95">
                    Voir les rappels
                </button>
                <button @click="reminderAlertModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODALE STATS DETAILL√âES Z-INDEX FIX -->
    <div v-if="statsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-4xl max-h-[90vh] flex flex-col pop-in">
             <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
                 <h3 class="font-bold text-xl text-slate-800">üìä Statistiques D√©taill√©es</h3>
                 <button @click="statsModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition">‚úï</button>
             </div>
             
             <!-- FILTRES STATS -->
             <div class="p-6 bg-white border-b border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Agence</label>
                    <select v-model="statsFilterAgency" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toutes les agences</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                 </div>
                 <!-- RESTRICTION UTILISATEUR ICI -->
                 <div v-if="user.role === 'admin'">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Commercial</label>
                    <select v-model="statsFilterUser" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toute l'√©quipe</option>
                        <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                    </select>
                 </div>
             </div>

             <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                 
                 <!-- CHIFFRES CLES FILTR√âS -->
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-slate-400 uppercase">Total Plac√©</p>
                         <p class="text-3xl font-black text-slate-800">{{ detailedStats.total }}</p>
                     </div>
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-green-400 uppercase">Honor√©s</p>
                         <p class="text-3xl font-black text-green-600">{{ detailedStats.honored }}</p>
                     </div>
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-red-400 uppercase">Pas Venu</p>
                         <p class="text-3xl font-black text-red-600">{{ detailedStats.noshow }}</p>
                     </div>
                     <div class="bg-blue-600 text-white p-4 rounded-2xl shadow-lg shadow-blue-200 text-center flex flex-col justify-center">
                         <p class="text-xs font-bold opacity-80 uppercase">Taux Transfo.</p>
                         <p class="text-3xl font-black">{{ detailedStats.rate }}%</p>
                     </div>
                 </div>

                 <p class="text-center text-xs text-gray-400 font-bold uppercase tracking-widest">Donn√©es pour le mois en cours</p>

             </div>
        </div>
    </div>
    
    <!-- MODALE EDITION EQUIPE Z-INDEX FIX -->
    <div v-if="teamEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Modifier Membre</h3>
            <div class="space-y-3">
                <input v-model="teamEditModal.name" placeholder="Nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.email" placeholder="Email / Identifiant" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.password" placeholder="Nouveau mot de passe (optionnel)" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" autocomplete="new-password">
            </div>
            
            <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es</h4>
                <div class="max-h-40 overflow-y-auto space-y-2 border rounded-xl p-2 bg-slate-50">
                    <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                        <input type="checkbox" :id="'edit-ag-'+ag.id" :value="ag.id" v-model="teamEditModal.assignedAgencies" class="custom-checkbox w-4 h-4">
                        <label :for="'edit-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="teamEditModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-xl font-bold">Annuler</button>
                <button @click="saveTeamMemberEdit" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <!-- MODALE CONFIRMATION UNIVERSELLE Z-INDEX FIX -->
    <div v-if="customConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center pop-in border border-slate-200">
             <div class="w-16 h-16 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 class="font-bold text-xl mb-2 text-slate-800">{{ customConfirmModal.title }}</h3>
            <p class="text-slate-500 mb-6">{{ customConfirmModal.message }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="customConfirmModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non</button>
                <button @click="customConfirmModal.onConfirm" class="bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg text-sm">Oui</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS Z-INDEX FIX -->
    <div v-if="settingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[300] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl h-[90vh] md:h-[80vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col fade-in">
            <div class="flex bg-slate-100 p-2 gap-2 border-b overflow-x-auto hide-scrollbar">
                <button @click="settingsModal.tab='Tarification'" :class="settingsModal.tab==='Tarification'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üí∂ Tarification</button>
                <button @click="settingsModal.tab='Agences'" :class="settingsModal.tab==='Agences'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üè¢ Agences</button>
                <button @click="settingsModal.tab='Equipe'" :class="settingsModal.tab==='Equipe'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üë• √âquipe</button>
                <button @click="settingsModal.tab='Admins'" :class="settingsModal.tab==='Admins'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üëë Admins</button>
                <button @click="settingsModal.tab='Messages'" :class="settingsModal.tab==='Messages'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üí¨ SMS</button>
                <button @click="settingsModal.tab='Sources'" :class="settingsModal.tab==='Sources'?'bg-white shadow text-blue-600':'text-gray-500 hover:bg-white/50'" class="px-4 md:px-6 py-3 rounded-xl font-bold transition flex-shrink-0 whitespace-nowrap">üîó Sources</button>
                <button @click="settingsModal.open=false" class="w-12 flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-xl transition ml-auto flex-shrink-0">‚úï</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50">
                
                <!-- ONGLET TARIFICATION (GLOBAL) -->
                <div v-if="settingsModal.tab==='Tarification'" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2"><i class="fa-solid fa-sack-dollar"></i> Salaire & Bonus (Configuration Globale)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Salaire de Base par RDV (‚Ç¨)</label>
                                <input type="number" v-model.number="globalCommission.base" class="w-full p-3 border rounded-xl font-black text-blue-600 text-lg">
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                            <h4 class="font-bold text-xs uppercase text-yellow-700 mb-2">Logique Palier R√©current</h4>
                            <div class="flex flex-wrap items-center gap-2 text-sm font-bold text-slate-700">
                                <span>√Ä partir de</span>
                                <input type="number" v-model.number="globalCommission.threshold" class="w-16 p-2 rounded border text-center">
                                <span>RDV, ajouter</span>
                                <input type="number" v-model.number="globalCommission.amount" class="w-20 p-2 rounded border text-center text-green-600">
                                <span>‚Ç¨ tous les</span>
                                <input type="number" v-model.number="globalCommission.step" class="w-16 p-2 rounded border text-center">
                                <span>RDV suivants.</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 italic">Exemple: √Ä partir de 21 RDV, tous les 10 RDV = 100‚Ç¨.<br>21 RDV = +100‚Ç¨, 31 RDV = +200‚Ç¨, 41 RDV = +300‚Ç¨...</p>
                        </div>
                        
                        <button @click="saveGlobalSettings" class="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg">Sauvegarder Configuration</button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2"><i class="fa-solid fa-hand-holding-dollar"></i> Pourboires (Ce Mois-ci)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="member in teamList" :key="member.id" class="p-4 border rounded-xl bg-slate-50 flex flex-col gap-2">
                                <div class="font-bold text-slate-800">{{ member.name }}</div>
                                <div class="flex items-center gap-2">
                                    <input type="number" v-model.number="tips[member.id]" placeholder="0" class="flex-1 p-2 border rounded-lg font-bold text-green-600">
                                    <button @click="saveTip(member.id)" class="bg-green-500 text-white w-10 h-10 rounded-lg hover:bg-green-600 transition shadow-sm"><i class="fa-solid fa-check"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Equipe'" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Ajouter un Prospecteur</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input v-model="newMember.name" placeholder="Nom / Pr√©nom" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.email" placeholder="Identifiant / Email" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.password" placeholder="Mot de passe" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addTeamMember" :disabled="!newMember.name || !newMember.email || !newMember.password" class="bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50 transition">Ajouter</button>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es (pour le nouveau membre)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto">
                                <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                                    <input type="checkbox" :id="'new-ag-'+ag.id" :value="ag.id" v-model="newMember.assignedAgencies" class="custom-checkbox w-4 h-4">
                                    <label :for="'new-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-slate-500 text-xs uppercase font-bold"><tr><th class="p-4">Nom</th><th class="p-4">Identifiant</th><th class="p-4">Agences</th><th class="p-4 hidden md:table-cell">Statut</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody class="divide-y"><tr v-for="member in teamList" :key="member.id" class="hover:bg-slate-50 transition"><td class="p-4 font-bold flex items-center gap-2">{{ member.name }} <button @click="openTeamEdit(member)" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pencil text-xs"></i></button></td><td class="p-4 text-blue-600 font-medium text-xs md:text-sm">{{ member.email }}</td><td class="p-4 text-xs text-gray-500 font-bold">{{ (member.assignedAgencies || []).length }} acc√®s</td><td class="p-4 hidden md:table-cell"><span v-if="member.blocked" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Bloqu√©</span><span v-else class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Actif</span></td><td class="p-4 text-right space-x-2"><button @click="toggleBlockTeamMember(member)" :class="member.blocked ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'" class="px-3 py-1.5 rounded-lg font-bold text-xs transition">{{ member.blocked ? 'D√©bloquer' : 'Bloquer' }}</button><button @click="deleteTeamMember(member)" class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-trash"></i></button></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Agences'" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div @click="openAgencyEdit(null)" class="border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center p-6 text-gray-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 cursor-pointer transition min-h-[150px]"><i class="fa-solid fa-plus text-4xl mb-2"></i><span class="font-bold">Ajouter Agence</span></div>
                        <div v-for="ag in agences" :key="ag.id" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 transition relative group">
                            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">{{ ag.nom }}</h3><div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition"><button @click.stop="openAgencyEdit(ag)" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteAgency(ag.id)" class="w-8 h-8 rounded-lg bg-red-100 text-red-600 hover:bg-red-200"><i class="fa-solid fa-trash"></i></button></div></div>
                            <p class="text-sm text-gray-500 mb-4 h-10 overflow-hidden">{{ ag.adresse }}</p>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t"><span class="font-bold text-lg text-slate-700">{{ formatPrice(ag.prix) }} <span class="text-[10px] text-gray-400 uppercase">{{ ag.tva ? 'TTC' : 'HT' }}</span></span><span :class="ag.statut_activite==='pause'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'" class="px-2 py-1 rounded text-xs font-bold uppercase">{{ ag.statut_activite === 'pause' ? 'Pause' : 'Actif' }}</span></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Admins'" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Configuration Globale</h3>
                        <!-- CONFIG NOTIF HEURE -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <!-- RAPPEL JOUR J -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Jour J)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV d'aujourd'hui.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderStartTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>
                            
                            <!-- RAPPEL VEILLE (NOUVEAU) -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t border-slate-200 pt-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Veille)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV de demain.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderEveTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>

                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end mt-2">Sauvegarder</button>
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-slate-700">G√©rer les Noms d'Administrateurs</h3>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newAdminName" placeholder="Nouveau pr√©nom (ex: Charl√®ne)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addAdminName" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div v-for="name in adminNamesList" :key="name" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <span class="font-bold text-slate-700 ml-2">{{ name }}</span>
                                <button @click="removeAdminName(name)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="settingsModal.tab==='Messages'" class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full overflow-hidden flex flex-col lg:grid">
                    <div class="lg:col-span-1 border-r lg:pr-6 space-y-4 overflow-y-auto max-h-[200px] lg:max-h-full">
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">1. Choisir l'Agence</h3>
                        <div class="space-y-2"><button v-for="ag in agences" @click="editingMsgAgence = ag" :class="editingMsgAgence?.id === ag.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white hover:bg-slate-100 text-slate-700'" class="w-full text-left px-4 py-3 rounded-xl font-bold transition text-sm flex items-center justify-between"><span>{{ ag.nom }}</span><i v-if="editingMsgAgence?.id === ag.id" class="fa-solid fa-chevron-right"></i></button></div>
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mt-6 mb-2">2. Type de Message</h3>
                        <div class="space-y-2"><button v-for="(label, key) in msgLabels" :key="key" @click="editingMsgType = key" :class="editingMsgType === key ? 'bg-slate-800 text-white shadow-md' : 'bg-white border hover:bg-slate-50 text-slate-600'" class="w-full text-left px-4 py-2 rounded-lg font-bold transition text-xs flex justify-between"><span>{{ label }}</span></button></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full overflow-y-auto">
                        <div v-if="editingMsgAgence" class="flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-blue-900 leading-tight">√âditer : {{ msgLabels[editingMsgType] }} <span class="text-gray-400 text-sm font-normal block md:inline">({{ editingMsgAgence.nom }})</span></h3><button @click="saveAgency(editingMsgAgence)" class="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg font-bold transition shadow-md text-sm">Enregistrer</button></div>
                            <div class="flex flex-wrap gap-2 mb-2 p-3 bg-slate-100 rounded-xl border border-slate-200"><button v-for="tag in ['{{NOM}}','{{DATE_LONG}}','{{HEURE}}','{{AGENCE}}','{{ADRESSE}}','{{PRIX}}','{{PLAN}}']" @click="insertTag(tag)" class="bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-blue-50 hover:border-blue-300 transition">{{ tag }}</button></div>
                            <textarea :value="editingMsgAgence.templates?.[editingMsgType] || getDefaultTemplate(editingMsgType)" @input="e => { if(!editingMsgAgence.templates) editingMsgAgence.templates={}; editingMsgAgence.templates[editingMsgType] = e.target.value }" class="w-full flex-1 p-4 border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-500 font-medium text-slate-700 leading-relaxed resize-none bg-slate-50 focus:bg-white transition min-h-[200px]"></textarea>
                        </div>
                        <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-2xl p-8">S√©lectionnez une agence.</div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Sources'" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">G√©rer les Sources</h3>
                        <div class="flex gap-2 mb-6"><input v-model="newSource" placeholder="Nouvelle source..." class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"><button @click="addSource" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="src in sourcesList" :key="src" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group"><div class="flex items-center gap-3"><img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain cursor-pointer hover:opacity-80" @click="changeSourceLogo(src)" title="Changer le logo"><span class="font-bold text-slate-700">{{ src }}</span></div><button @click="removeSource(src)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>

            </div>
             <!-- BOUTON FERMER LES R√âGLAGES (DEMANDE) -->
            <div class="p-4 bg-white border-t flex justify-center">
                <button @click="settingsModal.open=false" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg">Fermer</button>
            </div>
        </div>
    </div>
    
    <!-- BULK MODAL Z-INDEX FIX -->
    <div v-if="bulkModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl" 
                 :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-600'">
                <i class="fa-solid text-3xl" :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'fa-trash-can' : 'fa-circle-question'"></i>
            </div>
            <h3 class="font-bold text-2xl mb-3 text-slate-800">√ätes-vous s√ªr ?</h3>
            <p class="text-slate-600 mb-8 font-medium text-lg leading-relaxed">{{ bulkModal.label }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="bulkModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non, annuler</button>
                <button @click="executeBulkAction" 
                        :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'"
                        class="text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95 text-sm">
                    Oui, confirmer
                </button>
            </div>
        </div>
    </div>
    
    <!-- EDITING AGENCY Z-INDEX FIX -->
    <div v-if="editingAgency" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 fade-in max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-6 text-slate-800">{{ editingAgency.id ? 'Modifier' : 'Nouvelle' }} Agence</h3><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Nom</label><input v-model="editingAgency.nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 font-bold"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Adresse Postale</label><input v-model="editingAgency.adresse" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Lien Google Maps (Short)</label><input v-model="editingAgency.maps" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 text-blue-600"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Phrase d'accroche (SMS)</label><input v-model="editingAgency.tagline" placeholder="Ex: votre expert rachat" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Prix HT (‚Ç¨)</label><input type="number" v-model="editingAgency.prix_ht" @input="calculateTTC" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">TVA (%)</label><input type="number" v-model="editingAgency.tva_taux" @input="calculateTTC" placeholder="20" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div></div><div class="flex items-center justify-between p-3 bg-slate-100 rounded-xl"><span class="font-bold text-slate-700">Prix Affich√© (TTC)</span><span class="text-xl font-black text-blue-600">{{ formatPrice(editingAgency.prix) }}</span></div><div><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.tva" class="custom-checkbox"> <span>Afficher "TTC" dans les SMS</span></label></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">√âtat de l'agence</label><div class="flex gap-2"><button @click="editingAgency.statut_activite='actif'" :class="editingAgency.statut_activite==='actif' ? 'bg-green-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">Actif</button><button @click="editingAgency.statut_activite='pause'" :class="editingAgency.statut_activite==='pause' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">En Pause</button></div></div><div v-if="editingAgency.statut_activite==='pause'" class="space-y-3 bg-red-50 p-4 rounded-xl border border-red-100 animate-fadeIn"><div><label class="text-xs font-bold text-red-500 uppercase">Motif de la pause</label><select v-model="pauseReasonSelect" @change="updatePauseReason" class="w-full p-2 border border-red-200 rounded-lg outline-none bg-white font-bold text-slate-700 mt-1"><option value="Vacances">Vacances</option><option value="Complet">Complet / Surcharg√©</option><option value="Travaux">Travaux</option><option value="Autre">Autre (personnalis√©)</option></select><input v-if="pauseReasonSelect==='Autre'" v-model="editingAgency.motif_pause" placeholder="Pr√©cisez le motif..." class="w-full mt-2 p-2 border border-red-200 rounded-lg outline-none bg-white"></div><div v-if="pauseReasonSelect==='Vacances'" class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-red-400 uppercase">D√©but</label><input type="date" v-model="editingAgency.date_pause_debut" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div><div><label class="text-[10px] font-bold text-red-400 uppercase">Fin (inclus)</label><input type="date" v-model="editingAgency.date_pause_fin" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div></div></div></div><div class="flex gap-4 mt-6"><button @click="editingAgency=null" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="saveEditingAgency" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Enregistrer</button></div></div></div>
    <!-- WIZARD Z-INDEX FIX -->
    <div v-if="wizard.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in">
            <div class="bg-slate-50 p-4 flex justify-between items-center border-b">
                <h3 class="font-bold text-lg">Nouveau Rendez-Vous</h3>
                <button @click="wizard.open=false" class="w-8 h-8 rounded-full hover:bg-slate-200">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <!-- STEP 1: AGENCE -->
                <div v-if="wizard.step===1">
                    <h4 class="text-center font-bold text-xl mb-4">Choisir l'agence</h4>
                    <div class="mb-4 relative">
                        <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        <input v-model="agencySearch" placeholder="Rechercher une agence..." class="w-full pl-10 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 font-bold">
                    </div>
                    <div class="grid grid-cols-1 gap-3 max-h-[50vh] overflow-y-auto">
                        <button v-for="ag in filteredAgences" @click="checkAgenceAndProceed(ag)" :class="ag.statut_activite==='pause' ? 'border-red-200 bg-red-50 hover:bg-red-100' : 'border-slate-200 hover:border-blue-500 hover:bg-blue-50'" class="p-4 border-2 rounded-xl text-left transition group relative flex flex-col justify-center min-h-[80px]">
                            <div class="font-bold text-lg leading-tight text-slate-800 group-hover:text-blue-600 mb-1">{{ ag.nom }}</div>
                            <div class="text-[10px] text-gray-400 truncate opacity-70 group-hover:opacity-100">{{ ag.adresse }}</div>
                            <div v-if="ag.statut_activite==='pause'" class="absolute top-2 right-2 text-red-500 bg-white rounded-full px-1.5 py-0.5 text-[10px] font-bold shadow-sm border border-red-100"><i class="fa-solid fa-pause"></i></div>
                        </button>
                        <div v-if="filteredAgences.length === 0" class="col-span-1 text-center text-gray-400 py-4 italic">Aucune agence trouv√©e.</div>
                    </div>
                </div>

                <!-- STEP 2: CLIENT -->
                <div v-if="wizard.step===2">
                    <h4 class="text-center font-bold text-xl mb-4">Client</h4>
                    <div class="flex justify-center gap-4 mb-4">
                        <button @click="form.civilite='M.'" :class="form.civilite==='M.'?'bg-blue-600 text-white':'bg-gray-100'" class="px-6 py-2 rounded-full font-bold">Monsieur</button>
                        <button @click="form.civilite='Mme'" :class="form.civilite==='Mme'?'bg-pink-500 text-white':'bg-gray-100'" class="px-6 py-2 rounded-full font-bold">Madame</button>
                    </div>
                    <div class="mb-4">
                        <input v-model="form.nom" placeholder="Nom ou Pr√©nom" class="w-full text-center text-lg border-b-2 p-2 outline-none focus:border-blue-600">
                    </div>
                    <!-- PHONE INPUT AVEC PASTE BUTTON -->
                    <div class="relative flex items-center justify-center">
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" :value="form.telephone" @input="onWizardPhoneInput" placeholder="06 12 34 56 78" class="w-full text-center text-2xl font-mono border-b-2 p-2 outline-none focus:border-blue-600 tracking-[0.3em] bg-transparent">
                        <button @click="pastePhoneNumber" class="absolute right-0 top-2 text-blue-600 hover:text-blue-800 bg-blue-50 p-2 rounded-full shadow-sm transition" title="Coller le num√©ro">
                            <i class="fa-solid fa-paste"></i>
                        </button>
                    </div>
                    <p v-if="clientExists" class="text-green-600 text-xs text-center mt-2 font-bold animate-pulse">‚ú® Client existant d√©tect√© ! Infos remplies.</p>
                    <div class="flex gap-2 mt-6">
                        <button @click="wizard.step--" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Retour</button>
                        <button @click="wizard.step++" :disabled="!form.nom || normalizePhone(form.telephone).length<10" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold disabled:opacity-50">Suivant</button>
                    </div>
                </div>

                <!-- STEP 3: DATE & HEURE -->
                <div v-if="wizard.step===3" class="flex flex-col h-full">
                    <h4 class="text-center font-bold text-xl mb-4 text-slate-800">Date & Heure du RDV</h4>
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider"><i class="fa-solid fa-calendar-alt text-blue-500"></i> Choisir le Jour :</h5>
                            <input type="date" v-model="form.date" @change="form.heure=null" class="p-1 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 shadow-sm cursor-pointer hover:bg-blue-50">
                        </div>
                        <div class="overflow-x-auto pb-2 hide-scrollbar snap-x flex space-x-2">
                            <button v-for="d in dateOptions" :key="d.val" @click="form.date=d.val; form.heure=null;" :class="[form.date===d.val ? 'bg-blue-600 text-white shadow-lg transform scale-[1.05] date-card-selected' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-400', d.isToday ? 'border-2 border-green-500 shadow-md' : '']" class="flex-shrink-0 w-16 h-20 rounded-lg flex flex-col items-center justify-center text-sm transition-all duration-300 snap-center date-card p-1">
                                <span :class="form.date===d.val ? 'text-blue-200' : 'text-slate-400'" class="text-[9px] font-bold uppercase mb-0 transition-colors">{{ d.dayName }}</span>
                                <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                                <span class="text-[9px] font-medium opacity-80 mt-1">{{ d.month }}</span>
                            </button>
                        </div>
                    </div>
                    <div v-if="form.date" class="overflow-y-auto hide-scrollbar flex-1 p-2 border border-slate-100 rounded-lg bg-white shadow-inner animate-fadeIn max-h-[300px]">
                        <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider mb-2"><i class="fa-solid fa-clock text-green-500"></i> Choisir l'Heure (09:00 - 19:00) :</h5>
                        <div class="space-y-3">
                            <div class="grid grid-cols-4 gap-2">
                                <button v-for="h in timeSlots" :key="h" @click="form.heure=h" :class="form.heure===h ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-green-50'" class="py-1.5 rounded-md text-xs font-bold transition-all duration-200">{{ h }}</button>
                            </div>
                            <div class="pt-2 flex justify-center border-t border-slate-100">
                                <input type="time" v-model="form.heure" class="border-2 border-blue-100 rounded-lg p-2 font-bold text-blue-900 text-center text-sm outline-none focus:border-blue-500 bg-blue-50 w-32">
                            </div>
                        </div>
                    </div>
                    <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border border-dashed border-gray-200 rounded-2xl"><p class="text-sm font-medium p-8">üìÖ Veuillez d'abord s√©lectionner une date ci-dessus.</p></div>
                    <div class="mt-4 flex gap-2">
                        <button @click="wizard.step--" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Retour</button>
                        <button @click="wizard.step++" :disabled="!form.date || !form.heure" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50">Suivant <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- STEP 4: V√âHICULE (LARGE CHOIX) -->
                <div v-if="wizard.step===4">
                    <h4 class="text-center font-bold text-xl mb-6">V√©hicule</h4>
                    <div class="flex flex-col items-center justify-center h-full py-4">
                        <div class="w-full relative group">
                            <i class="fa-solid fa-car absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.modele" list="car-models" placeholder="Marque, Mod√®le, Finition..." class="w-full pl-12 p-4 text-lg border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700">
                            <!-- DATALIST FOR AUTOCOMPLETE -->
                            <datalist id="car-models">
                                <option v-for="car in commonCars" :key="car" :value="car"></option>
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-400 mt-3 text-center">Tapez pour voir les suggestions ou √©crivez librement.</p>
                    </div>
                    <div class="flex gap-2 mt-8">
                        <button @click="wizard.step--" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Retour</button>
                        <button @click="wizard.step++" :disabled="!form.modele" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold disabled:opacity-50">Suivant</button>
                    </div>
                </div>

                <!-- STEP 5: SOURCE -->
                <div v-if="wizard.step===5">
                    <h4 class="text-center font-bold text-xl mb-6">Source du RDV</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <button v-for="src in sourcesList" @click="selectSource(src)" :class="form.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' : 'border-slate-200 bg-white hover:border-blue-300'" class="p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition transform active:scale-95 shadow-sm">
                            <img :src="getLogo(src)" class="w-10 h-10 rounded-lg object-contain">
                            <span class="font-bold text-slate-700">{{ src }}</span>
                        </button>
                    </div>
                    <div class="flex gap-2 mt-8">
                        <button @click="wizard.step--" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Retour</button>
                    </div>
                </div>

                <!-- STEP 6: R√âCAPITULATIF (FIN) -->
                <div v-if="wizard.step===6">
                    <h4 class="text-center font-bold text-xl mb-4 text-blue-900">R√©capitulatif</h4>
                    <div class="bg-slate-50 p-4 rounded-xl space-y-2 text-sm border border-slate-200 shadow-sm">
                        <div class="flex justify-between"><span>Client</span> <b>{{ form.civilite }} {{ form.nom }}</b></div>
                        <div class="flex justify-between"><span>Tel</span> <b>{{ form.telephone }}</b></div>
                        <div class="flex justify-between"><span>Date</span> <b>{{ formatDateFr(form.date) }} √† {{ form.heure }}</b></div>
                        <div class="flex justify-between"><span>V√©hicule</span> <b>{{ form.modele }}</b></div>
                        <div class="flex justify-between"><span>Source</span> <b>{{ form.source }}</b></div>
                        <div class="flex justify-between border-t pt-2 mt-2"><span>Agence</span> <b class="text-blue-600">{{ form.agence.nom }}</b></div>
                        <div v-if="user.role==='admin'" class="flex justify-between"><span>Prix estim√©</span> <b :class="form.agence.tva ? 'text-slate-700' : 'text-gray-500'">{{ formatPrice(form.agence.prix) }} {{ form.agence.tva ? 'TTC' : 'HT' }}</b></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button @click="wizard.step--" class="bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Retour</button>
                        <button @click="finalizeRdv('a_confirmer')" class="bg-orange-100 text-orange-700 py-3 rounded-xl font-bold hover:bg-orange-200">Confirmer + Tard</button>
                    </div>
                    <a :href="generateMsgLink(form, 'confirm')" @click="finalizeRdv('confirme')" target="_blank" class="block w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl hover:bg-green-600 mt-2 flex items-center justify-center gap-2 transform active:scale-95 transition">
                        <i class="fa-solid fa-paper-plane"></i> SMS & Valider
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CANCEL MODAL Z-INDEX FIX -->
    <div v-if="cancelModal.open" class="fixed inset-0 bg-slate-900/60 z-[350] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center"><h3 class="font-bold text-lg mb-4">Qui a annul√© ?</h3><div class="space-y-3"><a :href="generateLink(cancelModal.rdv, 'cancel_clt')" target="_blank" @click="confirmCancel(cancelModal.rdv, 'client')" class="block w-full bg-slate-100 hover:bg-slate-200 py-3 rounded-xl font-bold text-slate-700 transition">Le Client</a><a :href="generateLink(cancelModal.rdv, 'cancel_ag')" target="_blank" @click="confirmCancel(cancelModal.rdv, 'agence')" class="block w-full bg-slate-100 hover:bg-slate-200 py-3 rounded-xl font-bold text-slate-700 transition">L'Agence</a><button @click="cancelModal.open=false" class="block w-full mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Retour</button></div></div></div>
    
    <!-- PAUSED AGENCY Z-INDEX FIX (Z-INDEX 500 pour √™tre devant Wizard) -->
    <div v-if="pausedAgencyModal.open" class="fixed inset-0 bg-slate-900/60 z-[500] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center animate-shake border-4 border-red-100"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ban"></i></div><h3 class="font-bold text-xl mb-2 text-slate-800">Agence Indisponible</h3><p class="text-slate-600 mb-6 font-medium">{{ getPauseMessage(pausedAgencyModal.agency) }}</p><button @click="pausedAgencyModal.open=false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Compris</button></div></div>
    
    <!-- RESCHEDULE Z-INDEX FIX -->
    <div v-if="rescheduleModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in"><div class="bg-slate-50 p-4 flex justify-between items-center border-b"><h3 class="font-bold text-lg text-slate-800">üìÖ Reporter Rendez-Vous</h3><button @click="rescheduleModal.open=false" class="w-8 h-8 rounded-full hover:bg-slate-200">‚úï</button></div><div v-if="rescheduleModal.step===1" class="p-6 overflow-y-auto space-y-4"><p class="text-sm font-bold text-blue-600 text-center mb-4">RDV Actuel: {{ formatDateFr(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</p><div class="mb-4"><div class="flex items-center justify-between mb-2"><h5 class="text-xs font-black uppercase text-slate-500 tracking-wider"><i class="fa-solid fa-calendar-alt text-blue-500"></i> Choisir le Nouveau Jour :</h5><input type="date" v-model="rescheduleModal.date" @change="rescheduleModal.heure=null" class="p-1 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 shadow-sm cursor-pointer hover:bg-blue-50"></div><div class="overflow-x-auto pb-2 hide-scrollbar snap-x flex space-x-2"><button v-for="d in dateOptions" :key="d.val" @click="rescheduleModal.date=d.val; rescheduleModal.heure=null;" :class="[rescheduleModal.date===d.val ? 'bg-blue-600 text-white shadow-lg transform scale-[1.05] date-card-selected' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-400', d.isToday ? 'border-2 border-green-500 shadow-md' : '']" class="flex-shrink-0 w-16 h-20 rounded-lg flex flex-col items-center justify-center text-sm transition-all duration-300 snap-center date-card p-1"><span :class="rescheduleModal.date===d.val ? 'text-blue-200' : 'text-slate-400'" class="text-[9px] font-bold uppercase mb-0 transition-colors">{{ d.dayName }}</span><span class="text-2xl font-black leading-none">{{ d.dayNum }}</span><span class="text-[9px] font-medium opacity-80 mt-1">{{ d.month }}</span></button></div></div><div v-if="rescheduleModal.date" class="overflow-y-auto hide-scrollbar p-2 border border-slate-100 rounded-lg bg-white shadow-inner animate-fadeIn max-h-[300px]"><h5 class="text-xs font-black uppercase text-slate-500 tracking-wider mb-2"><i class="fa-solid fa-clock text-green-500"></i> Choisir la Nouvelle Heure (09:00 - 19:00) :</h5><div class="space-y-3"><div class="grid grid-cols-4 gap-2"><button v-for="h in timeSlots" :key="h" @click="rescheduleModal.heure=h" :class="rescheduleModal.heure===h ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-green-50'" class="py-1.5 rounded-md text-xs font-bold transition-all duration-200">{{ h }}</button></div><div class="pt-2 flex justify-center border-t border-slate-100"><input type="time" v-model="rescheduleModal.heure" class="border-2 border-blue-100 rounded-lg p-2 font-bold text-blue-900 text-center text-sm outline-none focus:border-blue-500 bg-blue-50 w-32"></div></div></div><div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border border-dashed border-gray-200 rounded-2xl"><p class="text-sm font-medium p-8">üìÖ Veuillez d'abord s√©lectionner une date ci-dessus.</p></div><div class="flex gap-2 mt-4"><button @click="rescheduleModal.open=false" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="confirmRescheduleStep1" :disabled="!rescheduleModal.date || !rescheduleModal.heure || (rescheduleModal.date === rescheduleModal.rdv.date && rescheduleModal.heure === rescheduleModal.rdv.heure)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50">Confirmer Report <i class="fa-solid fa-arrow-right"></i></button></div></div><div v-if="rescheduleModal.step===2" class="p-8 text-center animate-fadeIn flex flex-col items-center justify-center h-full"><div class="w-20 h-20 bg-green-100 text-green-500 text-4xl rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-200/50 animate-bounce"><i class="fa-solid fa-check"></i></div><h4 class="text-2xl font-black text-slate-800 mb-2">Report valid√© !</h4><p class="text-slate-600 font-medium mb-8 max-w-xs mx-auto">Le rendez-vous a bien √©t√© d√©plac√© au <br><strong class="text-blue-600">{{ formatDateLong(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</strong>.</p><div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 w-full"><p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Voulez-vous pr√©venir le client ?</p><div class="grid grid-cols-1 gap-3"><button @click="sendRescheduleSMS" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center justify-center gap-3"><i class="fa-solid fa-comment-sms text-xl"></i> OUI, envoyer le SMS</button><button @click="rescheduleModal.open=false; clientModal.open=false; rescheduleModal.step=1" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">Non, revenir au RDV</button></div></div></div></div></div>

    <!-- HONOR MODAL Z-INDEX FIX -->
    <div v-if="honorModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200 relative overflow-hidden">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                <i class="fa-solid fa-file-signature text-3xl"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Honorer le RDV</h3>
            <p class="text-slate-500 font-medium mb-8">Le client a-t-il sign√© un Mandat ?</p>
            
            <div class="space-y-3">
                <button @click="finalizeHonor(true)" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-double text-xl"></i> ‚úÖ AVEC Mandat (OK M)
                </button>
                <button @click="finalizeHonor(false)" class="w-full bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition">
                   Je ne sais pas
                </button>
            </div>
            <button @click="honorModal.open=false" class="mt-6 text-gray-400 text-sm hover:text-gray-600 font-bold">Annuler</button>
        </div>
    </div>

    <!-- NOUVELLE MODALE √âDITION CLIENT Z-INDEX FIX -->
    <div v-if="editModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col pop-in">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-pencil mr-2"></i> Modifier Infos Client</h3>
                <button @click="editModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Nom Client</label>
                    <input v-model="editModal.form.nom" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">T√©l√©phone</label>
                    <input v-model="editModal.form.telephone" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Mod√®le V√©hicule</label>
                    <input v-model="editModal.form.modele" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Agence</label>
                    <select v-model="editModal.form.agenceId" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 bg-white">
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Source</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="src in sourcesList" :key="src" @click="editModal.form.source=src" :class="editModal.form.source===src ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="px-3 py-1.5 rounded-lg text-xs font-bold transition">
                            {{ src }}
                        </button>
                    </div>
                </div>
                <button @click="saveEdit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg mt-2 transform active:scale-95 transition">Sauvegarder</button>
            </div>
        </div>
    </div>

</div>


<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDi3NFvmg_acIxicfShqhEd4uQEDMDcizM",
        authDomain: "bon-de-commande-b05f6.firebaseapp.com",
        projectId: "bon-de-commande-b05f6",
        storageBucket: "bon-de-commande-b05f6.firebasestorage.app",
        messagingSenderId: "884603881750",
        appId: "1:884603881750:web:816da99e2502225779a837"
    };
    firebase.initializeApp(firebaseConfig);
    // --- PERSISTANCE INSTANTAN√âE ---
    firebase.firestore().enablePersistence()
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Persistance non active (onglet multiple).");
            } else if (err.code == 'unimplemented') {
                console.warn("Persistance non support√©e par le navigateur.");
            }
        });
    const db = firebase.firestore();

    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
        setup() {
            const user = reactive({ logged:false, role:'', name:'' });
            const loginEmail = ref('');
            const loginPass = ref('');
            const loginAdminSelection = ref(false); 
            
            const view = ref('dashboard');
            const currentFilter = ref('all'); 
            const listFilters = reactive({ agenceId: '', date: '', prospecteur: '' }); 
            const fromDashboard = ref(false);

            const dashboardFilters = reactive({ agencyId: '', userId: '', onlyLive: false });
            const dashboardLimit = ref(15);
            const displayLimit = ref(20); 

            const now = ref(new Date()); 
            const rdvList = ref([]);
            let rdvListener = null;

            const agences = ref([]);
            const sourcesList = ref(['Leboncoin', 'La Centrale', 'Facebook', 'Google', 'Instagram']);
            const sourceLogos = ref({}); 
            const adminNamesList = ref(['Nathana√´l', 'Charl√®ne', 'Admin']);
            const globalSettings = ref({ reminderStartTime: '08:00', reminderEveTime: '16:00' }); 
            
            // GLOBAL COMMISSION SETTINGS
            const globalCommission = reactive({ base: 10, threshold: 21, step: 10, amount: 100 });
            const tips = reactive({}); // { memberId: currentMonthTipAmount }

            const selectedIds = ref([]);
            const bulkModal = reactive({ open: false, action: '', label: '' });
            const agencySearch = ref('');

            const wizard = reactive({ open:false, step:1 });
            const form = reactive({});
            const clientModal = reactive({ open:false, rdv:null });
            const settingsModal = reactive({ open:false, tab:'Agences' });
            const cancelModal = reactive({ open:false, rdv:null });
            const rescheduleModal = reactive({ open:false, step:1, date:'', heure:'', rdv:null, oldDate:null, oldHeure:null });
            const pausedAgencyModal = reactive({ open:false, agency:null });
            
            const honorModal = reactive({ open: false, rdv: null });
            const editModal = reactive({ open: false, rdv: null, form: {} });
            const discountModal = reactive({ open: false, amount: null, reason: '', customReason: '', error: '' });
            const reminderAlertModal = reactive({ open: false });
            const pendingStatusModal = reactive({ open: false });
            const teamEditModal = reactive({ open: false, member: null, name: '', email: '', password: '', assignedAgencies: [] });
            const customConfirmModal = reactive({ open: false, title: '', message: '', onConfirm: null });
            const statsModal = reactive({ open: false });

            // Flag de session pour les v√©rifications au d√©marrage
            const checksDone = ref(false);
            const startupTimer = ref(null);

            const statsFilterAgency = ref('');
            const statsFilterUser = ref('');

            const newSource = ref('');
            const newAdminName = ref('');
            const showDiscountInput = ref(false);
            const newNoteText = ref('');

            const editingAgency = ref(null);
            const editingMsgAgence = ref(null);
            const editingMsgType = ref('confirm');
            const clientExists = ref(false);
            const pauseReasonSelect = ref('Vacances');
            const showCustomTime = ref(false);
            const mobileMenuOpen = ref(false);
            
            const currentTheme = computed(() => {
                const d = new Date();
                const month = d.getMonth() + 1; 
                const day = d.getDate();
                if (month === 12) return { name: 'christmas', label: 'Joyeuses F√™tes', icon: 'üéÖ', classes: 'theme-christmas' };
                if (month === 1 && day <= 15) return { name: 'newyear', label: 'Bonne Ann√©e', icon: 'ü•Ç', classes: 'theme-newyear' };
                if (month === 2 && day >= 10 && day <= 15) return { name: 'love', label: 'Love is in the air', icon: '‚ù§Ô∏è', classes: 'theme-love' };
                if (month === 10 && day >= 15) return { name: 'halloween', label: 'Bouuh !', icon: 'üéÉ', classes: 'theme-halloween' };
                if (month >= 6 && month <= 8) return { name: 'summer', label: 'Mode √ât√©', icon: 'üòé', classes: 'theme-summer' };
                if (month === 7 && day >= 13 && day <= 15) return { name: 'bastille', label: 'F√™te Nationale', icon: 'üéÜ', classes: 'theme-bastille' };
                return { name: 'default', label: '', icon: '', classes: '' };
            });

            const welcomeModal = reactive({ open: false, title: '', message: '', icon: '' });
            const teamList = ref([]);
            const newMember = reactive({ name:'', email:'', password:'', assignedAgencies: [] });

            const msgLabels = { 'confirm': 'Confirmation', 'rappel': 'Rappel Veille', 'rappel_today': 'Rappel Jour J', 'reschedule': 'Report', 'cancel_ag': 'Annulation Agence', 'cancel_clt': 'Annulation Client', 'noshow': 'Lapin', 'noshow_today': 'Lapin (Jour J)' };
            const filters = reactive({ date: new Date().toISOString().split('T')[0] });
            const search = ref('');
            const normalizePhone = (value) => (value || '').replace(/\D/g, '');
            const formatPhone = (digits) => digits.replace(/(\d{2})(?=\d)/g, '$1 ').trim();

            onMounted(() => {
                const savedUser = localStorage.getItem('crm_user');
                if(savedUser) {
                    const parsed = JSON.parse(savedUser);
                    user.logged = true;
                    user.role = parsed.role;
                    user.name = parsed.name;
                    loadRdvData();
                }

                db.collection('agences').onSnapshot(snap => agences.value = snap.docs.map(d => ({id:d.id, templates:{}, ...d.data()})));
                db.collection('settings').doc('global').onSnapshot(snap => {
                    if(snap.exists) { 
                        const data = snap.data(); 
                        if(data.sources) sourcesList.value = data.sources; 
                        if(data.logos) sourceLogos.value = data.logos;
                        if(data.adminNames) adminNamesList.value = data.adminNames;
                        if(data.reminderStartTime) globalSettings.value.reminderStartTime = data.reminderStartTime;
                        if(data.reminderEveTime) globalSettings.value.reminderEveTime = data.reminderEveTime;
                        // Load Commission Settings
                        if(data.commission) {
                            Object.assign(globalCommission, data.commission);
                        }
                    }
                });
                
                db.collection('users').onSnapshot(snap => {
                    teamList.value = snap.docs.map(d => {
                        const data = d.data();
                        // Load tips for current month
                        const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                        if (data.tips && data.tips[currentMonthKey]) {
                            tips[d.id] = data.tips[currentMonthKey];
                        } else {
                            tips[d.id] = 0;
                        }
                        return {id:d.id, assignedAgencies: [], ...data};
                    });
                });

                setInterval(() => { now.value = new Date(); }, 10000);
            });

            const visibleAgencies = computed(() => {
                if (user.role === 'admin') return agences.value;
                const currentUserObj = teamList.value.find(u => u.name === user.name);
                const allowedIds = currentUserObj?.assignedAgencies || [];
                return agences.value.filter(a => allowedIds.includes(a.id));
            });

            const loadRdvData = () => {
                if(rdvListener) rdvListener();
                let query = db.collection('rendezvous');
                if(user.role !== 'admin') {
                    query = query.where('createdBy', '==', user.name);
                }
                rdvListener = query.onSnapshot(snap => {
                    rdvList.value = snap.docs.map(d => {
                        const data = d.data();
                        const created = data.created && data.created.toDate ? data.created.toDate() : (data.created ? new Date(data.created) : null);
                        return {id:d.id, ...data, created};
                    });

                    // V√âRIFICATION D√âMARRAGE (Debounce pour attendre chargement complet)
                    if (user.logged && !checksDone.value) {
                        if (startupTimer.value) clearTimeout(startupTimer.value);
                        startupTimer.value = setTimeout(() => {
                            performStartupChecks();
                        }, 1000); 
                    }
                });
            };

            const performStartupChecks = () => {
                if (checksDone.value) return; 
                
                // 1. STATUTS MANQUANTS (Priorit√© Absolue)
                const pendingCount = rdvList.value.filter(r => { 
                    if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; 
                    if(!r.date || !r.heure) return false; 
                    const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; 
                    return new Date().getTime() > end; 
                }).length;

                if (pendingCount > 0) {
                    pendingStatusModal.open = true;
                    checksDone.value = true;
                    return; // Bloque les autres alertes
                }

                // 2. RAPPELS
                const currentHour = new Date().getHours();
                const startHour = parseInt(globalSettings.value.reminderStartTime.split(':')[0] || "8");
                const canShowToday = currentHour >= startHour;
                const eveStartHour = parseInt(globalSettings.value.reminderEveTime.split(':')[0] || "16");
                const canShowVeille = currentHour >= eveStartHour;

                const hasVeille = rappelsVeilleCount.value > 0;
                const hasJour = rappelsJourCount.value > 0;

                if ((hasVeille && canShowVeille) || (hasJour && canShowToday)) {
                    reminderAlertModal.open = true;
                }
                
                checksDone.value = true;
            };

            const checkAndShowWelcome = (email, name) => {
                const today = new Date().toISOString().split('T')[0];
                const lastLoginKey = 'lastWelcome_' + email;
                const lastLoginDate = localStorage.getItem(lastLoginKey);
                if (lastLoginDate !== today) {
                    const hour = new Date().getHours();
                    const isMorning = hour < 13;
                    welcomeModal.title = isMorning ? `Bonjour ${name} !` : `Re-bonjour ${name} !`;
                    welcomeModal.message = isMorning ? "J'esp√®re que vous allez bien ! Passez une excellente matin√©e ! üí™" : "J'esp√®re que votre matin√©e s'est bien pass√©e. Bonne fin de journ√©e ! üöÄ";
                    welcomeModal.icon = isMorning ? '‚òÄÔ∏è' : 'üëã';
                    welcomeModal.open = true;
                    launchFireworks();
                    localStorage.setItem(lastLoginKey, today);
                }
            };

            const saveGlobalSettings = async () => {
                await db.collection('settings').doc('global').set({
                    reminderStartTime: globalSettings.value.reminderStartTime,
                    reminderEveTime: globalSettings.value.reminderEveTime,
                    commission: globalCommission
                }, { merge: true });
                alert("Param√®tres sauvegard√©s !");
            };
            
            const saveTip = async (memberId) => {
                const amount = tips[memberId];
                if (amount === undefined || amount === null) return;
                const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                
                // Get existing tips map or create new
                const memberRef = db.collection('users').doc(memberId);
                const doc = await memberRef.get();
                let existingTips = doc.data().tips || {};
                
                existingTips[currentMonthKey] = amount;
                
                await memberRef.update({ tips: existingTips });
                alert("Pourboire enregistr√© !");
            };

            const currentFullDateLabel = computed(() => new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
            const conversionRate = computed(() => { const honored = rdvList.value.filter(r => r.statut === 'honore').length; const noshow = rdvList.value.filter(r => r.statut === 'pas_venu').length; const totalFinished = honored + noshow; if (totalFinished === 0) return 0; return Math.round((honored / totalFinished) * 100); });
            const conversionRateColor = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'bg-red-50 border-red-200 text-red-700'; if (rate < 80) return 'bg-orange-50 border-orange-200 text-orange-700'; return 'bg-green-50 border-green-200 text-green-700'; });
            const conversionEmoji = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'üò≠'; if (rate < 80) return 'ü§®'; return 'ü§©'; });

            const login = () => { 
                if(loginEmail.value === 'contact@cetn-solutions.fr' && loginPass.value === '130724') {
                    loginAdminSelection.value = true;
                    return;
                }
                const match = teamList.value.find(u => u.email === loginEmail.value && u.password === loginPass.value);
                if(match) {
                    if(match.blocked) { alert("Acc√®s bloqu√©. Contactez l'administrateur."); return; }
                    setUserSession('prospecteur', match.name);
                    checkAndShowWelcome(match.email, match.name);
                } else {
                    alert('Identifiants incorrects');
                }
            };

            const finalizeAdminLogin = (name) => {
                setUserSession('admin', name);
                checkAndShowWelcome(loginEmail.value, name);
                loginAdminSelection.value = false;
            };

            const setUserSession = (role, name) => {
                user.logged = true; user.role = role; user.name = name;
                localStorage.setItem('crm_user', JSON.stringify({ role, name }));
                loadRdvData();
            };

            const logout = () => { 
                user.logged=false; loginPass.value=''; loginEmail.value=''; rdvList.value = [];
                checksDone.value = false; 
                localStorage.removeItem('crm_user'); 
                if(rdvListener) rdvListener();
            };

            const addTeamMember = async () => { if(!newMember.name || !newMember.email || !newMember.password) return; await db.collection('users').add({ ...newMember, role: 'prospecteur', blocked: false, created: new Date() }); newMember.name = ''; newMember.email = ''; newMember.password = ''; newMember.assignedAgencies = []; };
            const toggleBlockTeamMember = async (member) => { await db.collection('users').doc(member.id).update({ blocked: !member.blocked }); };
            const deleteTeamMember = async (member) => { 
                openCustomConfirm("Supprimer un membre", "Voulez-vous vraiment supprimer l'acc√®s de " + member.name + " ?", async () => {
                    await db.collection('users').doc(member.id).delete();
                    customConfirmModal.open = false;
                });
            };
            
            const openTeamEdit = (member) => {
                teamEditModal.member = member;
                teamEditModal.name = member.name;
                teamEditModal.email = member.email;
                teamEditModal.password = ''; 
                teamEditModal.assignedAgencies = member.assignedAgencies || [];
                teamEditModal.open = true;
            };

            const saveTeamMemberEdit = async () => {
                if (!teamEditModal.member) return;
                const updateData = { 
                    name: teamEditModal.name, 
                    email: teamEditModal.email, 
                    assignedAgencies: teamEditModal.assignedAgencies
                };
                if(teamEditModal.password && teamEditModal.password.trim() !== '') { updateData.password = teamEditModal.password; }
                await db.collection('users').doc(teamEditModal.member.id).update(updateData);
                teamEditModal.open = false;
            };

            const addAdminName = async () => { if(!newAdminName.value) return; const updated = [...adminNamesList.value, newAdminName.value]; await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); newAdminName.value = ''; };
            const removeAdminName = async (name) => { const updated = adminNamesList.value.filter(n => n !== name); await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); };

            const addNote = async () => {
                if(!newNoteText.value.trim() || !clientModal.rdv) return;
                const noteObj = { text: newNoteText.value, author: user.name, date: new Date().toISOString() };
                if(!clientModal.rdv.notes) clientModal.rdv.notes = [];
                clientModal.rdv.notes.push(noteObj);
                await db.collection('rendezvous').doc(clientModal.rdv.id).update({ notes: clientModal.rdv.notes });
                newNoteText.value = '';
            };
            const deleteNote = async (rdv, index) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    rdv.notes.splice(index, 1);
                    await db.collection('rendezvous').doc(rdv.id).update({ notes: rdv.notes });
                    customConfirmModal.open = false;
                });
            };

            const onWizardPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); form.telephone = formatPhone(digits); if (digits.length === 10) { const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits); if (exist) { form.nom = exist.nom; form.civilite = exist.civilite; form.modele = exist.modele; clientExists.value = true; } else { clientExists.value = false; } } else { clientExists.value = false; } };
            const onModalPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); if (!clientModal.rdv) return; clientModal.rdv.telephone = formatPhone(digits); };
            const startWizard = () => { Object.assign(form, { agence:null, civilite:'M.', nom:'', telephone:'', date:'', heure:'', modele:'', source:'' }); clientExists.value = false; wizard.step = 1; wizard.open = true; agencySearch.value = ''; showCustomTime.value = false; };
            const checkAgenceAndProceed = async (ag) => { if(ag.statut_activite === 'pause' && ag.motif_pause === 'Vacances' && ag.date_pause_fin) { const today = new Date().toISOString().split('T')[0]; if (today > ag.date_pause_fin) { await db.collection('agences').doc(ag.id).update({ statut_activite: 'actif', motif_pause: '', date_pause_debut: '', date_pause_fin: '' }); ag.statut_activite = 'actif'; } } if(ag.statut_activite === 'pause') { pausedAgencyModal.agency = ag; pausedAgencyModal.open = true; return; } form.agence = ag; wizard.step++; };
            
            const getPauseMessage = (ag) => { 
                if(!ag) return ''; 
                if (ag.motif_pause === 'Vacances') {
                    if (ag.date_pause_debut && ag.date_pause_fin) {
                        const start = new Date(ag.date_pause_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        const end = new Date(ag.date_pause_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        return `Cette agence est en vacances du ${start} au ${end}.`; 
                    } else { return "Cette agence est en vacances (Dates non pr√©cis√©es)."; }
                }
                if(ag.motif_pause === 'Complet') return "Cette agence est compl√®te (Surcharg√©e)."; 
                if(ag.motif_pause === 'Travaux') return "Cette agence est ferm√©e pour travaux."; 
                return `Cette agence est indisponible pour le motif suivant : ${ag.motif_pause || 'Pause momentan√©e'}.`; 
            };
            
            const selectSource = (src) => { if (!form.modele || !form.modele.trim()) { alert('Merci de renseigner le mod√®le du v√©hicule avant de continuer.'); return; } form.source = src; wizard.step++; };
            const finalizeRdv = async (statut) => { await db.collection('rendezvous').add({ ...form, agenceId: form.agence.id, prix: parseFloat(form.agence.prix)||0, statut, created: new Date(), createdBy: user.name, rappelFait: false }); wizard.open = false; };
            
            const openRdvFiche = (r) => { clientModal.rdv = { ...r }; showDiscountInput.value = !!r.geste_commercial; clientModal.open = true; };
            const updateRdv = async (r) => { await db.collection('rendezvous').doc(r.id).update(r); clientModal.open = false; };
            const softDeleteRdv = (r) => { selectedIds.value = [r.id]; clientModal.open = false; openBulkConfirm('soft_delete', 'Envoyer ce RDV √† la corbeille ?'); };
            const deleteRdv = softDeleteRdv;
            
            const openCancelChoice = (r) => { cancelModal.rdv = r; cancelModal.open = true; };
            const confirmCancel = async (r, who) => { await db.collection('rendezvous').doc(r.id).update({ statut: 'annule', motif: who, honorBilling: null }); cancelModal.open = false; clientModal.open = false; };
            const quickCancel = async (r) => { openCustomConfirm("Annulation Rapide", "Annuler ce rendez-vous maintenant ?", async () => { await db.collection('rendezvous').doc(r.id).update({ statut: 'annule', honorBilling: null }); customConfirmModal.open = false; }); };
            
            const openEdit = (r) => { editModal.rdv = r; editModal.form = { nom: r.nom, telephone: r.telephone, modele: r.modele, source: r.source, agenceId: r.agenceId }; editModal.open = true; };
            const saveEdit = async () => {
                if(!editModal.rdv) return;
                if (editModal.form.agenceId !== editModal.rdv.agenceId) {
                    const newAgency = agences.value.find(a => a.id === editModal.form.agenceId);
                    if (newAgency) { editModal.form.prix = parseFloat(newAgency.prix) || 0; }
                }
                Object.assign(editModal.rdv, editModal.form); 
                if(clientModal.rdv && clientModal.rdv.id === editModal.rdv.id) Object.assign(clientModal.rdv, editModal.form);
                await db.collection('rendezvous').doc(editModal.rdv.id).update(editModal.form);
                editModal.open = false;
            };

            const openHonorCheck = (r) => { honorModal.rdv = r; honorModal.open = true; };
            const finalizeHonor = async (withMandat) => {
                if(!honorModal.rdv) return;
                const r = honorModal.rdv;
                const patch = { statut: 'honore', honorBilling: 'facture', tag: withMandat ? 'OK M' : null };
                await db.collection('rendezvous').doc(r.id).update(patch);
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) { Object.assign(clientModal.rdv, patch); }
                launchFireworks();
                honorModal.open = false;
                clientModal.open = false;
            };
            
            const openDiscountModal = () => { discountModal.amount = null; discountModal.reason = ''; discountModal.customReason = ''; discountModal.error = ''; discountModal.open = true; };
            const saveDiscount = async () => {
                discountModal.error = '';
                if (!discountModal.amount && discountModal.amount !== 0) { discountModal.error = "Veuillez entrer un montant."; return; }
                let finalReason = discountModal.reason;
                if (finalReason === 'Autre') finalReason = discountModal.customReason;
                if (!finalReason) { discountModal.error = "Veuillez choisir ou saisir un motif."; return; }
                if (clientModal.rdv) {
                    clientModal.rdv.geste_commercial = discountModal.amount;
                    clientModal.rdv.motif_geste = finalReason;
                    await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: discountModal.amount, motif_geste: finalReason });
                }
                discountModal.open = false;
            };
            const removeDiscount = async () => {
                openCustomConfirm("Supprimer le geste", "Voulez-vous retirer le geste commercial ?", async () => {
                    if (clientModal.rdv) {
                        clientModal.rdv.geste_commercial = null; clientModal.rdv.motif_geste = null;
                        await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: firebase.firestore.FieldValue.delete(), motif_geste: firebase.firestore.FieldValue.delete() });
                        discountModal.open = false; customConfirmModal.open = false;
                    }
                });
            }

            const updateStatus = async (r, s) => { 
                if(s==='honor_fact') { openHonorCheck(r); return; } 
                const patch = { statut: s };
                if(s==='honor_free') { patch.statut='honore'; patch.honorBilling='gratuit'; launchFireworks(); } 
                if(s==='noshow') { patch.statut='pas_venu'; patch.honorBilling=null; const today = new Date().toISOString().split('T')[0]; let type = 'noshow'; if(r.date === today) type = 'noshow_today'; const link = generateMsgLink(r, type); if(link) window.open(link, '_blank'); } 
                if(s==='reset') { patch.statut='confirme'; patch.honorBilling=null; patch.motif=null; delete patch.geste_commercial; delete patch.motif_geste; patch.tag = null; } 
                await db.collection('rendezvous').doc(r.id).update(patch); 
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) Object.assign(clientModal.rdv, patch);
                clientModal.open = false; 
            };

            const launchFireworks = () => { for(let i=0; i<50; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.top = -10 + 'px'; c.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random()*5)]; c.style.animationDuration = (Math.random() * 2 + 1) + 's'; document.body.appendChild(c); setTimeout(() => c.remove(), 3000); } };

            const openRescheduleModal = (r) => { rescheduleModal.rdv = r; rescheduleModal.date = r.date; rescheduleModal.heure = r.heure; rescheduleModal.oldDate = r.date; rescheduleModal.oldHeure = r.heure; rescheduleModal.step = 1; rescheduleModal.open = true; };
            const confirmRescheduleStep1 = async () => { 
                if(!rescheduleModal.date || !rescheduleModal.heure) return alert('Date/Heure requises'); 
                const newDate = rescheduleModal.date; const newHeure = rescheduleModal.heure;
                const oldInfo = `Ancien : ${formatDateFr(rescheduleModal.rdv.date)} √† ${rescheduleModal.rdv.heure}`;
                const note = { text: `üìÖ RDV Report√©. ${oldInfo}`, author: 'Syst√®me', date: new Date().toISOString() };
                let notes = rescheduleModal.rdv.notes || []; notes.push(note);
                await db.collection('rendezvous').doc(rescheduleModal.rdv.id).update({ date: newDate, heure: newHeure, notes: notes }); 
                rescheduleModal.rdv.date = newDate; rescheduleModal.rdv.heure = newHeure; rescheduleModal.rdv.notes = notes;
                if(clientModal.rdv && clientModal.rdv.id === rescheduleModal.rdv.id) { clientModal.rdv.date = newDate; clientModal.rdv.heure = newHeure; clientModal.rdv.notes = notes; }
                rescheduleModal.step = 2; 
            };
            const sendRescheduleSMS = () => { const link = generateMsgLink(rescheduleModal.rdv, 'reschedule'); if(link) window.open(link, '_blank'); rescheduleModal.open = false; clientModal.open = false; rescheduleModal.step = 1; };
            const openReschedule = (r) => openRescheduleModal(r);
            
            const changeView = (v) => { view.value = v; displayLimit.value = 20; if(v !== 'list') { currentFilter.value = 'all'; } selectedIds.value = []; };
            const resetListFilters = () => { search.value = ''; listFilters.agenceId = ''; listFilters.date = ''; listFilters.prospecteur = ''; currentFilter.value = 'all'; displayLimit.value=20; };
            const showUpcoming = () => { currentFilter.value = 'upcoming'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showLive = () => { currentFilter.value = 'live'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showHonored = () => { currentFilter.value = 'honored'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showNoShow = () => { currentFilter.value = 'noshow'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showCancelled = () => { currentFilter.value = 'cancelled'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const goBackFromList = () => { if (fromDashboard.value) { view.value = 'dashboard'; fromDashboard.value = false; resetListFilters(); } else { resetListFilters(); } };

            const filteredAgences = computed(() => { 
                let source = visibleAgencies.value;
                if(!agencySearch.value) return source; 
                const s = agencySearch.value.toLowerCase(); 
                return source.filter(ag => ag.nom.toLowerCase().includes(s)); 
            });
            const trashList = computed(() => rdvList.value.filter(r => r.statut === 'poubelle'));
            const trashCount = computed(() => trashList.value.length);
            const restoreRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('restore_trash', 'Restaurer ce rendez-vous ?'); };
            const hardDeleteRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ce rendez-vous ? (Irr√©versible)'); };

            const isEnCours = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= start && now.value < end && ['confirme','a_confirmer'].includes(r.statut); };
            const activeRdvCount = computed(() => rdvList.value.filter(r => isEnCours(r)).length);

            const filteredList = computed(() => { 
                let l = rdvList.value.filter(r => r.statut !== 'poubelle'); 
                if (listFilters.agenceId) l = l.filter(r => r.agenceId === listFilters.agenceId);
                if (listFilters.prospecteur) l = l.filter(r => r.createdBy === listFilters.prospecteur);
                if (listFilters.date) l = l.filter(r => r.date === listFilters.date);
                if (currentFilter.value === 'upcoming') { if (!listFilters.date) { const today = new Date().toISOString().split('T')[0]; l = l.filter(r => r.statut === 'confirme' && r.date >= today); } } 
                else if (currentFilter.value === 'live') l = l.filter(r => isEnCours(r));
                else if (currentFilter.value === 'honored') l = l.filter(r => r.statut === 'honore');
                else if (currentFilter.value === 'noshow') l = l.filter(r => r.statut === 'pas_venu');
                else if (currentFilter.value === 'cancelled') l = l.filter(r => r.statut === 'annule');
                if (search.value) { const s = search.value.toLowerCase(); const sDigits = normalizePhone(search.value); l = l.filter(r => (r.nom || '').toLowerCase().includes(s) || (r.modele || '').toLowerCase().includes(s) || (sDigits && normalizePhone(r.telephone).includes(sDigits))); } 
                const noBaseFilter = currentFilter.value === 'all' && !listFilters.agenceId && !listFilters.prospecteur && !listFilters.date && !search.value;
                if (noBaseFilter) return [];
                return l.sort((a, b) => { if (a.date !== b.date) return a.date.localeCompare(b.date); return (a.heure || '').localeCompare(b.heure || ''); });
            });
            const displayedList = computed(() => filteredList.value.slice(0, displayLimit.value));

            const allProspectors = computed(() => { const activeTeam = teamList.value.map(u => u.name); const admins = adminNamesList.value; return Array.from(new Set([...activeTeam, ...admins])).sort(); });
            const selectAll = (e) => { const list = view.value === 'trash' ? trashList.value : filteredList.value; if(e.target.checked) { selectedIds.value = list.map(r => r.id); } else { selectedIds.value = []; } };
            const toggleSelection = (id) => { if(selectedIds.value.includes(id)) { selectedIds.value = selectedIds.value.filter(i => i !== id); } else { selectedIds.value.push(id); } };
            const isAllSelected = computed(() => { const list = view.value === 'trash' ? trashList.value : filteredList.value; return list.length > 0 && selectedIds.value.length === list.length; });

            const openBulkConfirm = (action, label) => { bulkModal.action = action; bulkModal.label = label; bulkModal.open = true; };
            const openCustomConfirm = (title, message, onConfirm) => { customConfirmModal.title = title; customConfirmModal.message = message; customConfirmModal.onConfirm = onConfirm; customConfirmModal.open = true; };
            const executeBulkAction = async () => {
                const batch = db.batch();
                if (bulkModal.action === 'soft_delete') { selectedIds.value.forEach(id => { const ref = db.collection('rendezvous').doc(id); batch.update(ref, { statut: 'poubelle' }); }); }
                else if (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash') { selectedIds.value.forEach(id => { const ref = db.collection('rendezvous').doc(id); batch.update(ref, { statut: 'confirme' }); }); }
                else if (bulkModal.action === 'delete_selection' || bulkModal.action === 'delete_trash') { selectedIds.value.forEach(id => { const ref = db.collection('rendezvous').doc(id); batch.delete(ref); }); }
                else if (bulkModal.action === 'empty_trash') { trashList.value.forEach(r => { const ref = db.collection('rendezvous').doc(r.id); batch.delete(ref); }); }
                else { let patch = {}; if (bulkModal.action === 'honor_fact') { patch = { statut: 'honore', honorBilling: 'facture' }; } else if (bulkModal.action === 'noshow') { patch = { statut: 'pas_venu', honorBilling: null }; } if(Object.keys(patch).length > 0) { selectedIds.value.forEach(id => { const ref = db.collection('rendezvous').doc(id); batch.update(ref, patch); }); } }
                await batch.commit(); selectedIds.value = []; bulkModal.open = false;
            };

            const formatDateFr = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '';
            const formatDateShort = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) : '';
            const formatDateLong = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'}) : '';
            const formatPrice = (p) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(p);
            const getAgenceName = (id) => agences.value.find(a=>a.id===id)?.nom || 'Inconnue';
            const getRappelType = (r) => { if (!r.date) return 'rappel'; const today = new Date(); today.setHours(0,0,0,0); const d = new Date(r.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) return 'rappel_today'; return 'rappel'; };
            const getRappelLabel = (r) => { const type = getRappelType(r); if(type === 'rappel_today') return 'Rappel Aujourd\'hui'; return 'Rappel Demain'; };
            
            const generateMsgLink = (data, type) => {
                const ag = agences.value.find(a => a.id === data.agenceId) || data.agence || {}; const tpls = ag.templates || {}; 
                let tpl = tpls[type]; 
                if (!tpl) tpl = getDefaultTemplate(type); 
                const showPrice = user.role === 'admin'; const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : ''; 
                let dateRappelStr = ''; if (data.date) { const today = new Date(); today.setHours(0,0,0,0); const d = new Date(data.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) dateRappelStr = "aujourd'hui"; else if (diffDays === 1) dateRappelStr = "demain"; else dateRappelStr = formatDateLong(data.date); }
                let oldDateLong = ''; let oldHeure = ''; if(type === 'reschedule' && rescheduleModal.oldDate) { oldDateLong = formatDateLong(rescheduleModal.oldDate); oldHeure = rescheduleModal.oldHeure || ''; }
                let msg = tpl.replace(/{{CIVILITE}}/g, data.civilite||'').replace(/{{NOM}}/g, data.nom||'').replace(/{{PRENOM}}/g, data.nom||'').replace(/{{DATE_LONG}}/g, formatDateLong(data.date)).replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(data.date)).replace(/{{HEURE}}/g, data.heure||'').replace(/{{MODELE}}/g, data.modele||'').replace(/{{AGENCE}}/g, ag.nom||'').replace(/{{ADRESSE}}/g, ag.adresse||'').replace(/{{PLAN}}/g, ag.maps||'').replace(/{{PRIX}}/g, prixStr).replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'');
                if(type === 'reschedule' && rescheduleModal.oldDate) { msg = msg.replace(/{{OLD_DATE_LONG}}/g, oldDateLong).replace(/{{OLD_HEURE}}/g, oldHeure); }
                const sep = navigator.userAgent.toLowerCase().includes('iphone') ? '&' : '?'; return `sms:${normalizePhone(data.telephone)}${sep}body=${encodeURIComponent(msg)}`;
            };
            const getDefaultTemplate = (t) => { if(t==='confirm') return "Bonjour {{NOM}}, RDV confirm√© le {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}}."; if(t==='reschedule') return "Report Confirm√© ‚Äì {{AGENCE}}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nBonjour,\nVotre rendez-vous du {{OLD_DATE_LONG}} √† {{OLD_HEURE}} est report√©.\n\n‚óÜ Nouveau RDV :\n‚Üí Date & Heure : {{DATE_LONG}} √† {{HEURE}}\n‚Üí Mod√®le : {{MODELE}}\n‚óÜ Lieu : {{ADRESSE}}\n\nMerci de nous pr√©venir en cas d‚Äôimpr√©vu\n\n√Ä bient√¥t,\nL‚Äô√©quipe {{AGENCE}}"; if(t==='rappel') return "Rappel RDV demain √† {{HEURE}} chez {{AGENCE}}."; if(t==='noshow') return "Bonjour {{NOM}}, vous n'√™tes pas venu au RDV."; if(t==='noshow_today') return "Bonjour {{NOM}}, vous aviez RDV aujourd'hui √† {{HEURE}} chez {{AGENCE}}. Vous n'√™tes pas venu."; return ""; };
            const openSettings = () => { settingsModal.open = true; if(agences.value.length) editingMsgAgence.value = agences.value[0]; };
            const openAgencyEdit = (ag) => { if(ag) { editingAgency.value = JSON.parse(JSON.stringify(ag)); if(editingAgency.value.motif_pause && !['Vacances','Complet','Travaux'].includes(editingAgency.value.motif_pause)) { pauseReasonSelect.value = 'Autre'; } else { pauseReasonSelect.value = editingAgency.value.motif_pause || 'Vacances'; } } else { editingAgency.value = { nom:'', adresse:'', maps:'', tagline:'', tva:true, prix:0, templates:{} }; } if(!editingAgency.value.statut_activite) editingAgency.value.statut_activite = 'actif'; };
            const updatePauseReason = () => { if(pauseReasonSelect.value !== 'Autre') { editingAgency.value.motif_pause = pauseReasonSelect.value; } else { editingAgency.value.motif_pause = ''; } };
            const calculateTTC = () => { const ht = parseFloat(editingAgency.value.prix_ht) || 0; const tva = parseFloat(editingAgency.value.tva_taux) || 0; editingAgency.value.prix = (ht * (1 + (tva / 100))).toFixed(2); };
            const saveEditingAgency = async () => { if(!editingAgency.value.nom) return; if(editingAgency.value.id) { await db.collection('agences').doc(editingAgency.value.id).update(editingAgency.value); } else { await db.collection('agences').add(editingAgency.value); } editingAgency.value = null; };
            const saveAgency = async (ag) => { await db.collection('agences').doc(ag.id).update(ag); };
            const deleteAgency = async (id) => { openCustomConfirm("Supprimer Agence", "Voulez-vous vraiment supprimer cette agence ?", async () => { await db.collection('agences').doc(id).delete(); customConfirmModal.open = false; }); };
            const addSource = async () => { if(!newSource.value) return; const updated = [...sourcesList.value, newSource.value]; await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); newSource.value = ''; };
            const removeSource = async (src) => { const updated = sourcesList.value.filter(s => s !== src); await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); };
            const changeSourceLogo = async (src) => { const url = prompt("Entrez l'URL de l'image pour " + src + " :"); if(url) { const newLogos = { ...sourceLogos.value, [src]: url }; await db.collection('settings').doc('global').set({ logos: newLogos }, { merge: true }); } };
            const getLogo = (src) => { if(sourceLogos.value && sourceLogos.value[src]) return sourceLogos.value[src]; const s = (src||'').toLowerCase(); if(s.includes('coin')) return 'https://upload.wikimedia.org/wikipedia/commons/e/e1/Leboncoin_Logo_2016.svg'; if(s.includes('centrale')) return 'https://play-lh.googleusercontent.com/y3t-tGfqK_uJ0XQYV9xLqXoXwzX_zXwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_Xw'; if(s.includes('facebook')) return 'https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg'; if(s.includes('google')) return 'https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg'; return `https://www.google.com/s2/favicons?domain=${s.replace(' ','')}.com&sz=64`; };
            const insertTag = (tag) => { if(!editingMsgAgence.value) return; const area = document.querySelector('textarea'); if(area) { area.setRangeText(tag, area.selectionStart, area.selectionEnd, 'end'); editingMsgAgence.value.templates[editingMsgType.value] = area.value; } };
            
            const dateOptions = computed(() => { const arr = []; const today = new Date(); const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']; const months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c']; for(let i=0; i<14; i++) { const d = new Date(); d.setDate(today.getDate()+i); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const localDateString = `${year}-${month}-${day}`; arr.push({ val: localDateString, dayName: days[d.getDay()], dayNum: d.getDate(), month: months[d.getMonth()], isToday: i === 0 }); } return arr; });
            const timeSlots = computed(() => { const slots = []; for (let hour = 9; hour <= 19; hour++) { const hStr = String(hour).padStart(2, '0'); slots.push(`${hStr}:00`); if (hour !== 19) { slots.push(`${hStr}:30`); } } return slots; });

            const commonCars = ref([
                "Renault Clio", "Renault Megane", "Renault Captur", "Renault Austral", "Renault Arkana", "Renault Zoe", "Renault Scenic", "Renault Espace", "Renault Twingo", "Renault Kangoo",
                "Peugeot 208", "Peugeot 2008", "Peugeot 308", "Peugeot 3008", "Peugeot 5008", "Peugeot 508", "Peugeot Rifter", "Peugeot Traveller",
                "Citroen C3", "Citroen C3 Aircross", "Citroen C4", "Citroen C5 Aircross", "Citroen C5 X", "Citroen Berlingo",
                "Volkswagen Golf", "Volkswagen Polo", "Volkswagen Tiguan", "Volkswagen T-Roc", "Volkswagen T-Cross", "Volkswagen Passat", "Volkswagen Touareg", "Volkswagen ID.3", "Volkswagen ID.4", "Volkswagen Golf R-Line",
                "Audi A1", "Audi A3", "Audi A4", "Audi A5", "Audi A6", "Audi Q2", "Audi Q3", "Audi Q5", "Audi Q7", "Audi Q8", "Audi RS3", "Audi RSQ3",
                "BMW S√©rie 1", "BMW S√©rie 3", "BMW S√©rie 5", "BMW X1", "BMW X3", "BMW X5", "BMW M2", "BMW M3", "BMW M4",
                "Mercedes Classe A", "Mercedes Classe C", "Mercedes Classe E", "Mercedes GLA", "Mercedes CLA", "Mercedes GLE", "Mercedes GLC",
                "Toyota Yaris", "Toyota Corolla", "Toyota C-HR", "Toyota RAV4", "Toyota Aygo", "Toyota Highlander",
                "Ford Fiesta", "Ford Puma", "Ford Focus", "Ford Kuga", "Ford Ranger", "Ford Mustang",
                "Fiat 500", "Fiat Panda", "Fiat Tipo", "Fiat 500X",
                "Dacia Sandero", "Dacia Duster", "Dacia Jogger", "Dacia Spring",
                "Hyundai Tucson", "Hyundai Kona", "Hyundai i20", "Hyundai i30", "Hyundai Ioniq 5",
                "Kia Sportage", "Kia Niro", "Kia Picanto", "Kia Rio", "Kia EV6",
                "Tesla Model 3", "Tesla Model Y", "Tesla Model S", "Tesla Model X",
                "Nissan Qashqai", "Nissan Juke", "Nissan X-Trail", "Nissan Leaf",
                "Mini Cooper", "Mini Countryman", "Mini Clubman",
                "Seat Ibiza", "Seat Leon", "Seat Arona", "Seat Ateca", "Seat Cupra",
                "Skoda Fabia", "Skoda Octavia", "Skoda Kamiq", "Skoda Karoq", "Skoda Kodiaq",
                "Volvo XC40", "Volvo XC60", "Volvo XC90",
                "Land Rover Evoque", "Land Rover Velar", "Land Rover Sport",
                "Porsche Macan", "Porsche Cayenne", "Porsche 911"
            ]);

            const pastePhoneNumber = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        let cleaned = text.replace(/^\+33/, '0').replace(/^0033/, '0').replace(/\D/g, '');
                        if (cleaned.startsWith('33') && cleaned.length === 11) cleaned = '0' + cleaned.substring(2);
                        if (cleaned.length > 10) cleaned = cleaned.substring(0, 10);
                        if (cleaned.length === 10) {
                            form.telephone = formatPhone(cleaned);
                            const digits = normalizePhone(form.telephone);
                            const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits);
                            if (exist) {
                                form.nom = exist.nom;
                                form.civilite = exist.civilite;
                                form.modele = exist.modele;
                                clientExists.value = true;
                            } else {
                                clientExists.value = false;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur collage:', err);
                }
            };

            const filteredDaily = computed(() => { 
                if (!rdvList.value) return [];
                let list = rdvList.value.filter(r => r.date === filters.date && r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
                if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
                if (dashboardFilters.onlyLive) list = list.filter(r => isEnCours(r));
                return list.sort((a,b) => a.heure.localeCompare(b.heure)).map(r => ({...r, agenceNom: agences.value.find(a=>a.id===r.agenceId)?.nom})); 
            });
            const displayedDaily = computed(() => filteredDaily.value.slice(0, dashboardLimit.value));
            const sortedDaily = computed(() => displayedDaily.value);
            const rdvTodayCount = computed(() => filteredDaily.value.length);
            const timelineActiveCount = computed(() => {
                if (!rdvList.value) return 0;
                let list = rdvList.value.filter(r => r.date === filters.date && r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
                if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
                return list.filter(r => isEnCours(r)).length;
            });
            
            const isSoon = (dStr) => {
                if (!dStr) return false;
                const nowDate = now.value ? new Date(now.value) : new Date();
                const today = new Date(nowDate); today.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                const diffDays = Math.round((d - today) / 86400000);
                if (diffDays === 0) return true;
                if (diffDays === 1) { const hour = nowDate.getHours(); return hour >= 16; }
                return false;
            };

            const isCreatedToday = (d) => {
                if (!d) return false;
                const date = new Date(d);
                const today = new Date();
                return (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear());
            };

            const getDayDiff = (dStr) => {
                if (!dStr) return null;
                const base = now.value ? new Date(now.value) : new Date(); base.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                return Math.round((d - base) / 86400000);
            };

            const rappelsList = computed(() => rdvList.value.filter((r) => ['confirme', 'a_confirmer'].includes(r.statut) && !r.rappelFait && isSoon(r.date) && !isCreatedToday(r.created) && (getDayDiff(r.date) !== 0 || (r.heure && r.heure > new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})))));
            const rappelFilters = reactive({ day: 'today', agenceId: '', userId: '' });
            const isRappelToday = (r) => getDayDiff(r.date) === 0;
            const isRappelTomorrow = (r) => getDayDiff(r.date) === 1;
            const rappelsDisplay = computed(() => {
                let list = rappelsList.value;
                if (rappelFilters.day === 'today') { list = list.filter((r) => isRappelToday(r)); } else if (rappelFilters.day === 'tomorrow') { list = list.filter((r) => isRappelTomorrow(r)); }
                if (rappelFilters.agenceId) { list = list.filter((r) => r.agenceId === rappelFilters.agenceId); }
                if (rappelFilters.userId) { list = list.filter((r) => r.createdBy === rappelFilters.userId); }
                return list;
            });
            const rappelsVeilleCount = computed(() => rappelsList.value.filter(r => isRappelTomorrow(r)).length);
            const rappelsJourCount = computed(() => rappelsList.value.filter(r => isRappelToday(r)).length);
            const confirmList = computed(() => rdvList.value.filter((r) => r.statut === 'a_confirmer'));
            const rappelCount = computed(() => rappelsList.value.length);
            const confirmCount = computed(() => confirmList.value.length);
            
            const detailedStats = computed(() => {
                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }

                let filteredList = rdvList.value.filter(r => { if (!r.date) return false; if (r.statut === 'poubelle') return false; const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
                if(statsFilterAgency.value) { filteredList = filteredList.filter(r => r.agenceId === statsFilterAgency.value); }
                if(targetUser) { filteredList = filteredList.filter(r => r.createdBy === targetUser); }
                
                const total = filteredList.length; const honored = filteredList.filter(r => r.statut === 'honore').length; const noshow = filteredList.filter(r => r.statut === 'pas_venu').length; const finished = honored + noshow; const rate = finished > 0 ? Math.round((honored / finished) * 100) : 0;
                return { total, honored, noshow, rate };
            });
            const openStatsModal = () => { statsFilterAgency.value = ''; statsFilterUser.value = ''; statsModal.open = true; };
            
            // Calcul des commissions pour le commercial connect√© (AVEC LOGIQUE RECURRENTE)
            const userCommissionStats = computed(() => {
                if (user.role === 'admin') return null; 
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                const honoredRdvs = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== user.name || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const count = honoredRdvs.length;
                let baseEarnings = count * basePrice;
                let bonusEarnings = 0;

                // Logique r√©currente: 
                // Si threshold=21, step=10, amount=100.
                // 21 -> 100
                // 31 -> 200
                if (count >= bonusThreshold) {
                    // (21-21)/10 + 1 = 1 * 100 = 100
                    // (31-21)/10 + 1 = 2 * 100 = 200
                    const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                    bonusEarnings = multiplier * bonusAmount;
                }

                // Add Tips
                const currentMonthKey = `${currentMonth}-${currentYear}`;
                // Get tip for this user from loaded tips object (reactive)
                const myUserEntry = teamList.value.find(u => u.name === user.name);
                let tipEarnings = 0;
                if(myUserEntry && tips[myUserEntry.id]) {
                    tipEarnings = tips[myUserEntry.id];
                }

                const totalEarnings = baseEarnings + bonusEarnings + tipEarnings;

                return { 
                    count, 
                    baseEarnings, 
                    bonusEarnings, 
                    tipEarnings, 
                    totalEarnings,
                    justReachedTier: (count >= bonusThreshold) && ((count - bonusThreshold) % bonusStep === 0) // Visual effect trigger
                };
            });

            // STATS ADMIN AVEC CALCUL MARGE
            const stats = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const upcoming = rdvList.value.filter(r => r.statut==='confirme').length;
                const honored = rdvList.value.filter(r => r.statut==='honore').length;
                const noshow = rdvList.value.filter(r => r.statut==='pas_venu').length;
                const cancelled = rdvList.value.filter(r => r.statut==='annule').length;

                // CA BRUT
                const ca = rdvList.value.filter(r => r.honorBilling==='facture').reduce((acc,r) => { 
                    const price = parseFloat(r.prix) || 0; 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // CA Journalier
                const ca_daily = rdvList.value.filter(r => r.honorBilling==='facture' && r.date === nowStr).reduce((acc,r) => { 
                    const price = parseFloat(r.prix) || 0; 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Commissions Totales
                const commissionMap = {}; 
                rdvList.value.forEach(r => {
                    if (r.statut === 'honore' && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy || 'Syst√®me';
                            if (!commissionMap[uName]) commissionMap[uName] = 0;
                            commissionMap[uName]++;
                        }
                    }
                });

                let totalCommissions = 0;
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                for (const [userName, count] of Object.entries(commissionMap)) {
                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Add Tips from teamList
                    const member = teamList.value.find(u => u.name === userName);
                    if (member && tips[member.id]) {
                        userTotal += parseFloat(tips[member.id]);
                    }

                    totalCommissions += userTotal;
                }

                const net = ca - totalCommissions;

                return { upcoming, honored, noshow, cancelled, ca, ca_daily, commissions: totalCommissions, net };
            });

            const isLateAndNoStatus = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= end && ['confirme','a_confirmer'].includes(r.statut); };
            const getProgressPercent = (r) => { if(!r.date || !r.heure) return 0; const start = new Date(r.date+'T'+r.heure).getTime(); const end = start + 3600000; const current = now.value.getTime(); if(current < start) return 0; if(current > end) return 100; return ((current - start) / (end - start)) * 100; };
            const getRdvTimeStatus = (r) => { if(!r.date || !r.heure) return 'futur'; const start = new Date(r.date+'T'+r.heure).getTime(); const current = now.value.getTime(); if(current >= start && current < start + 3600000) return 'en_cours'; if(current < start && (start - current) < 172800000) return 'bientot'; return 'futur'; };
            const getRelativeRdvLabel = (r) => { if (!r.date || !r.heure) return ''; const nowDate = now.value ? new Date(now.value) : new Date(); const start = new Date(r.date + 'T' + r.heure); const dureeRdvMs = 60 * 60 * 1000; const diffMs = start - nowDate; if (diffMs <= -dureeRdvMs) return ''; if (diffMs < 0 && diffMs > -dureeRdvMs) { return 'RDV en cours'; } const diffMin = Math.round(diffMs / 60000); if (diffMin < 1) { return "RDV dans moins d‚Äô1 minute"; } if (diffMin < 60) { return `RDV dans ${diffMin} min`; } const diffHours = Math.floor(diffMin / 60); const restMin = diffMin % 60; if (diffHours < 24) { if (restMin === 0) { return `RDV dans ${diffHours}h`; } return `RDV dans ${diffHours}h ${restMin}min`; } const diffDays = Math.round(diffMin / (24 * 60)); if (diffDays === 1) { return 'RDV dans 1 jour'; } return `RDV dans ${diffDays} jours`; };
            const nextRdvLabel = computed(() => { if (!rdvList.value || rdvList.value.length === 0) return ''; const todayStr = new Date().toISOString().split('T')[0]; const nowDate = now.value ? new Date(now.value) : new Date(); const candidates = rdvList.value.filter(r => r.date === todayStr && r.statut !== 'poubelle' && r.heure).map(r => ({ rdv: r, start: new Date(r.date + 'T' + r.heure) })).filter(o => o.start > nowDate); if (candidates.length === 0) return ''; candidates.sort((a, b) => a.start - b.start); return getRelativeRdvLabel(candidates[0].rdv); });
            const pendingStatusList = computed(() => { return rdvList.value.filter(r => { if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; if(!r.date || !r.heure) return false; const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; return now.value.getTime() > end; }); });
            const pendingStatusCount = computed(() => pendingStatusList.value.length);
            const displayStatus = (r) => { if(r.statut === 'honore') return user.role==='admin' ? (r.honorBilling==='facture'?'Honor√© ‚Ä¢ Factur√©':'Honor√© ‚Ä¢ Non factur√©') : 'Honor√©'; if(r.statut === 'pas_venu') return 'Pas Venu'; if(r.statut === 'annule') return 'Annul√©'; if(r.statut === 'a_confirmer') return '√Ä Confirmer'; return 'Confirm√©'; };
            const statusClass = (s) => ({ 'honore': 'bg-green-100 text-green-700', 'pas_venu': 'bg-red-100 text-red-700', 'annule': 'bg-gray-200 text-gray-500', 'a_confirmer': 'bg-orange-100 text-orange-700', 'confirme': 'bg-blue-100 text-blue-700' }[s] || 'bg-gray-100');
            const validateAction = async (r, type) => { if(type==='rappels') await db.collection('rendezvous').doc(r.id).update({ rappelFait:true }); if(type==='confirmations') await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' }); };
            const generateLink = (r, type) => generateMsgLink(r, type);

            return {
                user, loginEmail, loginPass, view, login, logout, loginAdminSelection, finalizeAdminLogin,
                rdvList, agences, sourcesList, stats, sortedDaily, filteredList, displayedList, rappelsList, confirmList, rappelCount, confirmCount,
                wizard, form, clientModal, settingsModal, cancelModal,
                rescheduleModal, openRescheduleModal, confirmRescheduleStep1, sendRescheduleSMS, deleteRdv: softDeleteRdv, softDeleteRdv,
                changeView, showUpcoming, showLive, showHonored, showNoShow, showCancelled, goBackFromList, fromDashboard, // NEW EXPORTS
                currentFilter, listFilters, resetListFilters, displayLimit,
                startWizard, finalizeRdv, selectSource,
                openRdvFiche, updateRdv, openCancelChoice, confirmCancel, quickCancel, updateStatus,
                openSettings, openAgencyEdit, saveEditingAgency, editingAgency, saveAgency, deleteAgency, addSource, removeSource, changeSourceLogo, getLogo,
                newSource, editingMsgAgence, editingMsgType, clientExists, insertTag, msgLabels,
                generateMsgLink, generateLink, validateAction,
                dateOptions, timeSlots, commonCars, pastePhoneNumber, showCustomTime, 
                filters, search, 
                formatDateFr, formatDateShort, formatDateLong, formatPrice, isEnCours, isLateAndNoStatus, displayStatus, statusClass, getAgenceName,
                normalizePhone, onWizardPhoneInput, onModalPhoneInput,
                getRappelType, getRappelLabel,
                openReschedule,
                currentFullDateLabel, checkAgenceAndProceed, pausedAgencyModal, pauseReasonSelect, updatePauseReason,
                getPauseMessage, getProgressPercent, getRdvTimeStatus,
                pendingStatusList, pendingStatusCount, getRelativeRdvLabel,
                selectedIds, selectAll, toggleSelection, isAllSelected, bulkModal, openBulkConfirm, executeBulkAction, 
                trashList, trashCount, restoreRdv, hardDeleteRdv,
                agencySearch, filteredAgences,
                calculateTTC, conversionRate, conversionRateColor, conversionEmoji, activeRdvCount,
                // NEW VARS
                teamList, newMember, addTeamMember, toggleBlockTeamMember, deleteTeamMember, mobileMenuOpen, welcomeModal,
                adminNamesList, newAdminName, addAdminName, removeAdminName,
                newNoteText, addNote,showDiscountInput, allProspectors, dashboardFilters, dashboardLimit, filteredDaily,rdvTodayCount, nextRdvLabel, currentTheme,
                honorModal, openHonorCheck, finalizeHonor,
                editModal, openEdit, saveEdit, deleteNote,
                
                discountModal, openDiscountModal, saveDiscount, removeDiscount,
                reminderAlertModal, rappelsVeilleCount, rappelsJourCount,
                teamEditModal, openTeamEdit, saveTeamMemberEdit, 
                customConfirmModal, openCustomConfirm, rappelFilters, rappelsDisplay,
                globalSettings, saveGlobalSettings,
                pendingStatusModal, 
                
                // NEW STATS & PRICING
                statsModal, openStatsModal, detailedStats, statsFilterAgency, statsFilterUser, visibleAgencies, userCommissionStats,
                globalCommission, tips, saveTip
            };
        }
    }).mount('#app');
</script>
</body> 
</html>
